<!--
  (C) 2019 NETDUMA Software
--> <link rel="import" href="/custom-elements/polymer/polymer.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-chart/duma-chart.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-legend/duma-legend.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <script src="/apps/com.netdumasoftware.adblocker/desktop/Scripts/utillity.js?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"></script> <link rel="import" href="/themes/<%= current_theme %>/duma-theme.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <dom-module id="adblock-status"> <template> <style include="duma-theme iron-flex"> :host {
        display: block;
        width: 100%;
      } </style> <div class="chart-wrapper"> <duma-legend vertical id="statusLegend" legend-stats="[[legendStats]]"></duma-legend> <duma-chart id="graph" type="doughnut"></duma-chart> </div> </template> <script> Polymer(
    {
      is: 'adblock-status',
      properties:
      {
        legendStats:
        {
          type: Array,
          value:
          [
            {
              label: "<%= i18n.totalQueries %>",
              result: "-",
              visible: false,
              disableClick: true,
            },
            {
              label: "<%= i18n.queriesAllowed %>",
              result: "-",
              visible: true,
              disableClick: true,
              patternIndex: 0,
            },
            {
              label: "<%= i18n.queriesBlocked %>",
              result: "-",
              visible: true,
              disableClick: true,
              patternIndex: 1
            },
          ]
        },
      },
      setLegendColour(index, colour)
      {
        var indexStr = index.toString();
        this.set(`legendStats.${indexStr}.colour`, colour);
        this.set(`legendStats.${indexStr}.bgColour`, colour);
      },
      setLegendResult(index, value)
      {
        var indexStr = index.toString();
        this.set(`legendStats.${indexStr}.result`, AddThousandsSeparators(value));
      },
      ready: function ()
      {
        // Colour selection
        var cgen = getColourGenerator();
        var colours = [cgen(), cgen(), '#FFFFFF'];
        this.setLegendColour(0, colours[2]);
        this.setLegendColour(1, colours[1]);
        this.setLegendColour(2, colours[0]);

        this.updateCount = 0;
        this.loaded = false;

        setInterval(function()
        {
          long_rpc_promise("com.netdumasoftware.burstwatch", "static_history", []).done(function(data)
          {
            var parsedData = data[0];
            var allowedQueries = parsedData.total_queries - parsedData.total_blocked_queries;
            this.setLegendResult(0, parsedData.total_queries);
            this.setLegendResult(1, allowedQueries);
            this.setLegendResult(2, parsedData.total_blocked_queries);

            this.$.graph.data.datasets[0].data = [parsedData.total_blocked_queries, allowedQueries];
            this.$.graph.update();
            this.$.statusLegend._forceUpdate();

            if (this.loaded == false)
            {
              $(this).closest("duma-panel").prop("loaded", true);
              this.loaded = true;
            }
          }.bind(this));
        }.bind(this), 1000);

        var data = [0, 0]

        var config =
        {
          data:
          {
            datasets:
            [
              {
                data: data,
                backgroundColor: colours,
                borderColor: "#00000000",
                label: 'Dataset 1',
                hoverBorderWidth: 0,
              },
            ],
            labels: ["<%= i18n.queriesAllowed %>", "<%= i18n.queriesBlocked %>"],
          },
          options:
          {
            ariaHeaders: ["<%= i18n.queriesType %>", "<%= i18n.total %>"],
            responsive: true,
            legend:
            {
              display: false,
            },
            title:
            {
              display: false,
            },
            animation:
            {
              animateScale: true,
              animateRotate: true,
            },
            tooltips:
            {
              enabled: false,
            },
          }
        };

        this.$.graph.options = config.options;
        this.$.graph.data = config.data;
      },
    }); </script> </dom-module> 