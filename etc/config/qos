#####new-archer generic QOS config after BRCM patch 1
###ethwan 8 queues - eth LAN 4 queues
#Internal Classification Labels

config label 'Normal'
	option trafficid '1'

config label 'Interactive'
	option trafficid '2'

config label 'Network_Control'
	option trafficid '3'

config label 'Video_Data'
	option trafficid '4'

config label 'Video_Sig'
	option trafficid '5'

config label 'Management'
	option trafficid '6'

config label 'Voice_Data'
	option trafficid '7'

config label 'Voice_Sig'
	option trafficid '8'

config label 'Multicast'
	option trafficid '9'

#Qos Class Definition (queue's)

#TO_WAN
config class 'W_Q0'
	option priority '0'

config class 'W_Q1'
	list trafficid '2'
	option priority '1'

config class 'W_Q2'
	list trafficid '3'
	list trafficid_tcpack '2'
	option priority '2'

config class 'W_Q3'
	list trafficid '4'
	list trafficid '9'

	option priority '3'

config class 'W_Q4'
	list trafficid '5'
	option priority '4'

config class 'W_Q5'
	list trafficid '6'

	option priority '5'

config class 'W_Q6'
	list trafficid '7'
	option priority '6'

config class 'W_Q7'
	list trafficid '8'
	option priority '7'

#TO_LAN
config class 'L_Q0'
	option priority '0'

config class 'L_Q1'
	list trafficid '2'
	list trafficid '3'
	option priority '1'

config class 'L_Q2'
	list trafficid '4'
	list trafficid '9'
	list trafficid '5'
	option priority '2'

config class 'L_Q3'
	list trafficid '6'
	list trafficid '7'
	list trafficid '8'
	option priority '3'

#TO_WLAN (priorities are fixed for WMM queues)
config class 'WMM_BK_Q0'
	option priority '0'

config class 'WMM_BK_Q1'
	option priority '1'

config class 'WMM_BE_Q0'
	option priority '2'

config class 'WMM_BE_Q1'

	list trafficid '9'
	option priority '3'

config class 'WMM_VI_Q0'
	list trafficid '4'

	option priority '4'

config class 'WMM_VI_Q1'
	list trafficid '5'
	list trafficid '6'
	option priority '5'

config class 'WMM_VO_Q0'
	list trafficid '7'
	option priority '6'

config class 'WMM_VO_Q1'
	list trafficid '8'
	option priority '7'

#Qos Classgroup Definition
config classgroup 'TO_WAN'
	option classes 'W_Q0 W_Q1 W_Q2 W_Q3 W_Q4 W_Q5 W_Q6 W_Q7'
	option default 'W_Q0'
	option policy 'sp'

config classgroup 'TO_LAN'
	option classes 'L_Q0 L_Q1 L_Q2 L_Q3'
	option default 'L_Q0'
	option policy 'sp'

config classgroup 'TO_WLAN'
# Fixed order, relates to hardcoded priorities
	option classes 'WMM_BE_Q0 WMM_BK_Q0 WMM_BK_Q1 WMM_BE_Q1 WMM_VI_Q0 WMM_VI_Q1 WMM_VO_Q0 WMM_VO_Q1'
	option default 'WMM_BE_Q0'
	option policy 'sp'

# Since QoSv2.1 it's preferred to set classgroup on device level
# (eth switch ports configured via firstboot)
config device 'wl0'
	option classgroup 'TO_WLAN'

config device 'wl1'
	option classgroup 'TO_WLAN'

config device 'wl1_1'
	option classgroup 'TO_WLAN'

config device 'eth0'
	option classgroup 'TO_LAN'
	option switchclassification 'dscp'

config device 'eth1'
	option classgroup 'TO_LAN'
	option switchclassification 'dscp'

config pcp2priomapping 'pcp2priomapper'
	option pcp0 '2'
	option pcp1 '0'
	option pcp2 '1'
	option pcp3 '3'
	option pcp4 '4'
	option pcp5 '5'
	option pcp6 '7'
	option pcp7 '7'

config dscp2priomapping 'dscp2priomapper'
	option dscp0 '0'
	option dscp1 '0'
	option dscp2 '0'
	option dscp3 '0'
	option dscp4 '0'
	option dscp5 '0'
	option dscp6 '0'
	option dscp7 '0'
	option dscp8 '0'
	option dscp9 '0'
	option dscp10 '0'
	option dscp11 '0'
	option dscp12 '0'
	option dscp13 '0'
	option dscp14 '0'
	option dscp15 '0'
	option dscp16 '1'
	option dscp17 '1'
	option dscp18 '1'
	option dscp19 '1'
	option dscp20 '1'
	option dscp21 '1'
	option dscp22 '1'
	option dscp23 '1'
	option dscp24 '1'
	option dscp25 '1'
	option dscp26 '1'
	option dscp27 '1'
	option dscp28 '1'
	option dscp29 '1'
	option dscp30 '1'
	option dscp31 '1'
	option dscp32 '2'
	option dscp33 '2'
	option dscp34 '2'
	option dscp35 '2'
	option dscp36 '2'
	option dscp37 '2'
	option dscp38 '2'
	option dscp39 '2'
	option dscp40 '2'
	option dscp41 '2'
	option dscp42 '2'
	option dscp43 '2'
	option dscp44 '2'
	option dscp45 '2'
	option dscp46 '2'
	option dscp47 '2'
	option dscp48 '3'
	option dscp49 '3'
	option dscp50 '3'
	option dscp51 '3'
	option dscp52 '3'
	option dscp53 '3'
	option dscp54 '3'
	option dscp55 '3'
	option dscp56 '3'
	option dscp57 '3'
	option dscp58 '3'
	option dscp59 '3'
	option dscp60 '3'
	option dscp61 '3'
	option dscp62 '3'
	option dscp63 '3'


# Rule type priority
# L2classify < Host < Classify < Reclassify

# Classify/Reclassify get applied in the order according to these principles :
#
#   - Reclassify after Classify
#   - from lower to higher order value
#   - for rules with order = 0 :
#     1. rules without source or destination interface
#     2. rules with source interface but no destination interface
#     3. rules with destination interface but no source interface
#     4. rules with source interface AND destination interface
#   - as a last option, according to the order they are defined in UCI config (currently true but not guaranteed in the future)

config rule
	option target 'Interactive'
	option proto 'tcp'
	option dstports '20,21,25,80,109,110,143,201,202,203,204,205,206,220,387'

config rule
	option target 'Interactive'
	option proto 'udp'
	option dstports '20,21,25,80,109,110,143,201,202,203,204,205,206,220,387'

config rule
	option target 'Interactive'
	option proto 'tcp'
	option dstports '443,993,995,1701,1935,3074,3478,3479,3480,3658,8080,37483'

config rule
	option target 'Interactive'
	option proto 'udp'
	option dstports '443,993,995,1701,1935,3074,3478,3479,3480,3658,8080,37483'

config rule
	option target 'Network_Control'
	option proto 'icmp'

config rule
	option target 'Network_Control'
	option proto 'ipv6-icmp'

config rule
	option target 'Network_Control'
	option proto 'tcp'
	option dstports '22,23,53,67,68,123'

config rule
	option target 'Network_Control'
	option proto 'udp'
	option dstports '22,23,53,67,68,123,500,4500'

config rule
	option target 'Network_Control'
	option proto 'esp'

config rule
	option target 'Network_Control'
	option proto 'ah'

#VPN's
config rule
	option target 'Network_Control'
	option proto 'gre'

# linked to rtsp helper (child connections will inherit the trafficid)
config rule
	option target 'Video_Sig'
	option proto 'tcp'
	option dstports '554'

# overrule inherited trafficid (helper match implies reclassify)
config rule
	option target 'Video_Data'
	option helper 'rtsp'
	option reclassify '1' # prevents warning about rule being automatically converted

# linked to sip helper (child connections will inherit the trafficid)
config rule
	option target 'Voice_Sig'
	option proto 'tcp'
	option dstports '5060'

config rule
	option target 'Voice_Sig'
	option proto 'udp'
	option dstports '5060'

# overrule inherited trafficid (helper match implies reclassify)
config rule
	option target 'Voice_Data'
	option helper 'sip'
	option reclassify '1' # prevents warning about rule being automatically converted

# multicast rules with higher order to get priority over standard rules that might overlap (i.e. dstports)
config rule
	option order '1'
	option target 'Multicast'
	option dsthost '224.0.0.0/4'

config rule
	option order '1'
	option target 'Multicast'
	option dsthost 'ff00::/8'

# Host-application rule replaces the old rule with dport 7547 for cwmpd
# (which would be broken once acs url is provisioned using another port via dhcpv4 option 43)
config host
	option target 'Management'
	option path '/usr/bin/cwmpd'

