#!/bin/sh /etc/rc.common

START=99
STOP=00

USE_PROCD=1

lxc_path="/srv/lxc"

lxc_rootfs() {
  local lxc="$1"

  grep "^lxc.rootfs.path" ${lxc_path}/${lxc}/config | tr -d " \"" | cut -d= -f2
}

start_ubus_forward() {
  local lxc="$1"
  local ubus_proxy
  local ubus_user
  local rootfs

  config_get ubus_proxy "${lxc}" ubus_proxy
  config_get ubus_user "${lxc}" ubus_user

  [ -z "${ubus_proxy}" ] && return 0

  rootfs=$(lxc_rootfs "${lxc}")
  [ -z "${rootfs}" ] && return 0

  mkdir -p ${rootfs}/$(dirname ${ubus_proxy})

  if [ ! -z ${ubus_user} ]; then
    ubus_user=",su=${ubus_user}"
  fi

  procd_open_instance "${lxc}_ubus_fwd"
  procd_set_param command socat -d -ly -lp${lxc}_ubp UNIX-LISTEN:${rootfs}/${ubus_proxy},fork${ubus_user} UNIX-CONNECT:/var/run/ubus.sock
  procd_close_instance
}

lxc_instance_start() {
  local lxc="${1}"
  local enabled

  config_get enabled "${lxc}" enabled "0"
  [ "${enabled}" = "0" ] && return 0

  start_ubus_forward "${lxc}"

  local config_file="${lxc_path}/${lxc}/config"
  procd_open_instance "${lxc}"
  procd_set_param command lxc-start -F -n "${lxc}"
  procd_set_param file "${config_file}"
  procd_close_instance
}

start_service() {
  local global_enabled

  config_load lxc
  config_get global_enabled global enabled "0"
  [ "${global_enabled}" = "0" ] && return 0

  /usr/sbin/update_lxc_config
  config_foreach lxc_instance_start lxc_instance
}

service_triggers()
{
  procd_add_reload_trigger lxc
}
