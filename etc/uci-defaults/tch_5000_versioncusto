#!/bin/sh

********************************************************************
*		Modifiing the SW version to the values required by Customer
*********************************************************************
board=`uci get env.var.hardware_version`


if [ $board == "VBNT-K" ]; then
	uci set versioncusto.override.fwversion_prefix='AGTEF_'
	transl="TI_versions"
elif [ $board == "VBNT-K_SFP" ]; then
	uci set versioncusto.override.fwversion_prefix='AGTHP_'
	transl="TI_versions_SFP"	
fi

	
#this will only be used during development/customization and will be removed normally together with closing the build 
#uci set versioncusto.override.fwversion_suffix='ti_open file 16.3.7187-2789001'


#firmware versions conversion table : homeware version -> TI version
#Add new entries in the 'here-document' below (before the EOTX ending line)
#leave the last line : 'Unknown' if no matching version
#top-down precedence order : if actual version does not match first field of first line, try next line
TI_versions(){
cat <<EOTXT
16.3.7172-2789002 1.0.0_001
16.3.7172-2781002 1.0.0_001
16.3.7187-2789001 1.0.0_002
16.3.7187-2781001 1.0.0_002
16.3.7187-2789002 1.0.0_002
16.3.7187-2781002 1.0.0_002
16.3.7187-2789003 1.0.0_002_DUMMY
16.3.7187-2781003 1.0.0_002_DUMMY
16.3.7187-2781007 1.0.0_003_DUMMY
16.3.7196-2789001 1.0.0_003
16.3.7196-2781001 1.0.0_003
16.3.7196-2789002 1.0.0_003
16.3.7196-2781002 1.0.0_003
16.3.7196-2789003 1.0.0_003_DUMMY
16.3.7196-2781003 1.0.0_003_DUMMY
16.3.7271-2789001 1.0.0
16.3.7271-2781001 1.0.0
16.3.7271-2789002 1.0.0
16.3.7271-2781002 1.0.0
16.3.7271-2789003 1.0.0_DUMMY
16.3.7271-2781003 1.0.0_DUMMY
16.3.7318-2789001 1.0.0_005
16.3.7318-2781001 1.0.0_005
16.3.7318-2789002 1.0.0_005
16.3.7318-2781002 1.0.0_005
16.3.7318-2789003 1.0.0_005_DUMMY
16.3.7318-2781003 1.0.0_005_DUMMY
16.3.7343-2789001 1.0.1
16.3.7343-2781001 1.0.1
16.3.7343-2789003 1.0.1
16.3.7343-2781003 1.0.1
16.3.7343-2789004 1.0.1_DUMMY
16.3.7343-2781004 1.0.1_DUMMY
16.3.7391-2789001 1.0.2_001
16.3.7391-2781001 1.0.2_001
16.3.7391-2789002 1.0.2_001
16.3.7391-2781002 1.0.2_001
16.3.7391-2789003 1.0.2_001_DUMMY
16.3.7391-2781003 1.0.2_001_DUMMY
16.3.7498-2789008 1.0.2
16.3.7498-2781008 1.0.2
16.3.7498-2789009 1.0.2
16.3.7498-2781009 1.0.2
16.3.7498-2789010 1.0.2_DUMMY
16.3.7498-2781010 1.0.2_DUMMY
16.3.7573-2789001 1.0.3_001
16.3.7573-2781001 1.0.3_001
16.3.7573-2789002 1.0.3_001
16.3.7573-2781002 1.0.3_001
16.3.7573-2789003 1.0.3_001_DUMMY
16.3.7573-2781003 1.0.3_001_DUMMY
16.3.7636-2789001 1.0.3_002
16.3.7636-2781001 1.0.3_002
16.3.7636-2789002 1.0.3_002
16.3.7636-2781002 1.0.3_002
16.3.7636-2789003 1.0.3_002_DUMMY
16.3.7636-2781003 1.0.3_002_DUMMY
16.3.7636-2789004 1.0.3_003
16.3.7636-2781004 1.0.3_003
16.3.7636-2789005 1.0.3_003
16.3.7636-2781005 1.0.3_003
16.3.7636-2789006 1.0.3_003_DUMMY
16.3.7636-2781006 1.0.3_003_DUMMY
16.3.7636-2789007 1.0.3
16.3.7636-2781007 1.0.3
16.3.7636-2789008 1.0.3
16.3.7636-2781008 1.0.3
16.3.7636-2789009 1.0.3_DUMMY
16.3.7636-2781009 1.0.3_DUMMY
17.1.7711-0009001 1.0.4_002
17.1.7711-0001001 1.0.4_002
17.1.7711-0009002 1.0.4_002
17.1.7711-0001002 1.0.4_002
17.1.7711-0009003 1.0.4_002_DUMMY
17.1.7711-0001003 1.0.4_002_DUMMY
17.1.7745-0009001 1.0.4_003
17.1.7745-0001001 1.0.4_003
17.1.7745-0009010 1.0.4_003
17.1.7745-0001010 1.0.4_003
17.1.7745-0009009 1.0.4_003_DUMMY
17.1.7745-0001009 1.0.4_003_DUMMY
.*	1.99.99.99 
EOTXT
}

TI_versions_SFP(){
cat <<EOTXT
17.1.7745-0009001 1.0.1_001
17.1.7745-0001001 1.0.1_001
17.1.7745-0009010 1.0.1_001
17.1.7745-0001010 1.0.1_001
17.1.7745-0009009 1.0.1_001_DUMMY
17.1.7745-0001009 1.0.1_001_DUMMY
17.1.7745-0009017 1.0.1_002
17.1.7745-0001017 1.0.1_002
17.1.7745-0009018 1.0.1_002
17.1.7745-0001018 1.0.1_002
17.1.7745-0009019 1.0.1_002_DUMMY
17.1.7745-0001019 1.0.1_002_DUMMY
.*	1.99.99.99 
EOTXT
}


#perform a translation (table based in this example : output 2nd field of matching version entry in PXS_versions table above)
#input params:
#   none
TI_translate_swversions(){
	tver=$($transl | awk -v srch="$(uci get env.var.friendly_sw_version_activebank)" 'srch ~ $1 {print $2}' | head -1)
	uci set env.var.friendly_sw_version_activebank=`uci get versioncusto.override.fwversion_prefix`"$tver"
	uci set versioncusto.override.fwversion_override="$tver"
#Populate user-agent
#user-agent format for TI: vendorname / <HWversion>/ <FWversion> / <SWversion>
	uci set mmpbxrvsipnet.sip_net.user_agent="$(uci get env.var.company_name) / $(uci get env.var.hardware_version) / `uci get versioncusto.override.fwversion_prefix`"$tver" / `uci get versioncusto.override.fwversion_prefix`"$tver""
	uci commit mmpbxrvsipnet
	
	tver=$($transl | awk -v srch="$(uci get env.var.friendly_sw_version_passivebank)" 'srch ~ $1 {print $2}' | head -1)
	uci set env.var.friendly_sw_version_passivebank=`uci get versioncusto.override.fwversion_prefix`"$tver"
#if no conversion needed : comment previous 3 lines
uci commit env
}



TI_translate_swversions



SW_Version=`lua -e "t=require'transformer.shared.banktable' value=t.getCurrentVersion() print(string.match(value,'([^%-]+)%-'))"`

#this will only be used during development/customization and will be removed normally together with closing the build 
#uci set versioncusto.override.fwversion_suffix='_Custo005'


uci commit versioncusto

