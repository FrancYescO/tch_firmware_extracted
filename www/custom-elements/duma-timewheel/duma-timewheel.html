<!--
Custom property | Description | Default
----------------|-------------|----------
`--duma-timewheel-section-color-allow`        | color of allow timewheel sections               | `--rating-a`
`--duma-timewheel-section-color-block`        | color of block timewheel sections               | `--rating-d`
`--duma-timewheel-section-color-reject`       | color of reject timewheel sections              | `--rating-c`
`--duma-timewheel-section-disabled-opacity`   | opacity of disabled timewheel sections          | `0.2`
`--duma-timewheel-section-focus-opacity`      | opacity of focused/hovered timewheel sections   | `0.5`
--> <link rel="import" href="/custom-elements/polymer/polymer.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-icons/iron-icons.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-icon-button/paper-icon-button.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-tooltip/paper-tooltip.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <dom-module is="duma-timewheel"> ​ <template> <style> :host {
        display: block;
        position: relative;
        width: 167px;
        padding: 2em;
      }

      :host[small] {
        width: 36px;
        padding: 0;
      }
      
      :host .wheel {
        display: block;
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        border-radius: 50%;
        position: relative;
        overflow: hidden;
      }

      :host:not([small]) #toggleall {
        text-transform: uppercase;
        margin: 0;
        opacity: 0.75;
        line-height: 1;
        position: absolute;
        bottom: 0;
        right: 0;
        text-align: center;
        width: 4em;
        font-size: 0.7em;
      }
      :host[small] #toggleall {
        display: none;
      }

      .am-pm {
        text-transform: uppercase;
        margin: 0;
        opacity: 0.75;
        line-height: 1;
        position: absolute;
        top: 0;
        left: 0;
      }
      :host[small] .am-pm {
        font-size: 10px;
        position: relative;
        margin-bottom: 3px;
        text-align: center;
      }
      
      :host[small]:first-of-type {
        margin-right: 1em;
      }
      
      .background {
        fill: var(--primary-background-color);
        fill-opacity: 0.5;
      }

      .segment {
        color: var(--duma-timewheel-section-color, --primary-text-color);
        fill: currentColor;
        fill-opacity: var(--duma-timewheel-section-disabled-opacity, 0.3);
        transition: fill ease 100ms, fill-opacity ease 100ms;
        cursor: pointer;        
      }
      .overlay {
        fill-opacity: 0;
        fill: currentColor;
        color: #ffffff;
        transition: fill ease 100ms, fill-opacity ease 100ms;
        pointer-events: none;
      }
      
      :host[small] .segment-group {
        cursor: default;
      }

      :host[allow=block] .segment-group.active .segment {
        color: var(--duma-timewheel-section-color-block, --rating-d);
      }
      :host[allow=reject] .segment-group.active .segment {
        color: var(--duma-timewheel-section-color-reject, --rating-c);
      }
      :host[allow=allow] .segment-group.active .segment {
        color: var(--duma-timewheel-section-color-allow, --rating-a);
      }
         
      :host .segment-group:focus {
        outline: none;
      }
      
      :host:not([small]) .segment-group:hover .overlay,
      :host:not([small]) .segment-group:focus .overlay {
        fill-opacity: var(--duma-timewheel-section-focus-opacity, 0.5);
      }
      
      :host .segment-group.active .segment {
        fill-opacity: 1;
      }         

      /* :host[small] .am-pm, */
      :host[small] .numbers {
        display: none;
      }

      .numbers {
        position: absolute;
        height: 100%;
        width: 100%;
        border-radius: 50%;
        top: 2px;
        right: 2px;
        z-index: 0;
      }

      .numbers div {
        display: block;
        position: absolute;
        width: 50%;
        top: -1px;
        left: 50%;
        height: 50%;
        transform-origin: 0% 100%;
        font-size: 12px;
      }

      .numbers div:nth-child(1) {
        transform: rotate(30deg);
      }

      .numbers div:nth-child(2) {
        transform: rotate(60deg);
      }

      .numbers div:nth-child(3) {
        transform: rotate(90deg);
      }

      .numbers div:nth-child(4) {
        transform: rotate(120deg);
      }

      .numbers div:nth-child(5) {
        transform: rotate(150deg);
      }

      .numbers div:nth-child(6) {
        transform: rotate(180deg);
      }

      .numbers div:nth-child(7) {
        transform: rotate(210deg);
      }

      .numbers div:nth-child(8) {
        transform: rotate(240deg);
      }

      .numbers div:nth-child(9) {
        transform: rotate(270deg);
      }

      .numbers div:nth-child(10) {
        transform: rotate(300deg);
      }

      .numbers div:nth-child(11) {
        transform: rotate(330deg);
      }

      .numbers div:nth-child(12) {
        transform: rotate(0deg);
      }

      .numbers div span {
        display: inline-block;
        position: relative;
        width: 1.5em;
        left: -0.75em;
        top: 0.25em;
        text-align: center;
      }

      .numbers div:nth-child(1) span {
        transform: rotate(-30deg);
      }

      .numbers div:nth-child(2) span {
        transform: rotate(-60deg);
      }

      .numbers div:nth-child(3) span {
        transform: rotate(-90deg);
      }

      .numbers div:nth-child(4) span {
        transform: rotate(-120deg);
      }

      .numbers div:nth-child(5) span {
        transform: rotate(-150deg);
      }

      .numbers div:nth-child(6) span {
        transform: rotate(-180deg);
      }

      .numbers div:nth-child(7) span {
        transform: rotate(-210deg);
      }

      .numbers div:nth-child(8) span {
        transform: rotate(-240deg);
      }

      .numbers div:nth-child(9) span {
        transform: rotate(-270deg);
      }

      .numbers div:nth-child(10) span {
        transform: rotate(-300deg);
      }

      .numbers div:nth-child(11) span {
        transform: rotate(-330deg);
      }

      .numbers div:nth-child(12) span {
        transform: rotate(0deg);
      }

      .toggle-all-tooltip {
        white-space: nowrap;
      } </style> <template is="dom-if" if="[[!pm]]"> <div class="am-pm"><%= i18n.am %></div> </template> <template is="dom-if" if="[[pm]]"> <div class="am-pm"><%= i18n.pm %></div> </template> <div class="numbers"> <div><span>[[_timeToString(0,pm)]]</span></div> <div><span>[[_timeToString(1,pm)]]</span></div> <div><span>[[_timeToString(2,pm)]]</span></div> <div><span>[[_timeToString(3,pm)]]</span></div> <div><span>[[_timeToString(4,pm)]]</span></div> <div><span>[[_timeToString(5,pm)]]</span></div> <div><span>[[_timeToString(6,pm)]]</span></div> <div><span>[[_timeToString(7,pm)]]</span></div> <div><span>[[_timeToString(8,pm)]]</span></div> <div><span>[[_timeToString(9,pm)]]</span></div> <div><span>[[_timeToString(10,pm)]]</span></div> <div><span>[[_timeToString(11,pm)]]</span></div> </div> <div class="wheel"> <!-- inline svg because it has polymer bindings --> <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" xml:space="preserve"> <g class="segment-group" aria-label="[[_timeAriaLabel(0,pm)]]" tabindex$="[[_canTab(0,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,0)]]" exclude-focus-outline> <path class="segment" d="M50,50V0c9.2,0,17,2.1,25,6.7L50,50z"/> <path class="overlay" d="M50,50V0c9.2,0,17,2.1,25,6.7L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(1,pm)]]" tabindex$="[[_canTab(1,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,1)]]" exclude-focus-outline> <path class="segment" d="M50,50L75,6.7C83,11.3,88.7,17,93.3,25L50,50z"/> <path class="overlay" d="M50,50L75,6.7C83,11.3,88.7,17,93.3,25L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(2,pm)]]" tabindex$="[[_canTab(2,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,2)]]" exclude-focus-outline> <path class="segment" d="M50,50l43.3-25c4.6,8,6.7,15.8,6.7,25H50z"/> <path class="overlay" d="M50,50l43.3-25c4.6,8,6.7,15.8,6.7,25H50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(3,pm)]]" tabindex$="[[_canTab(3,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,3)]]" exclude-focus-outline> <path class="segment" d="M50,50h50c0,9.2-2.1,17-6.7,25L50,50z"/> <path class="overlay" d="M50,50h50c0,9.2-2.1,17-6.7,25L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(4,pm)]]" tabindex$="[[_canTab(4,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,4)]]" exclude-focus-outline> <path class="segment" d="M50,50l43.3,25C88.7,83,83,88.7,75,93.3L50,50z"/> <path class="overlay" d="M50,50l43.3,25C88.7,83,83,88.7,75,93.3L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(5,pm)]]" tabindex$="[[_canTab(5,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,5)]]" exclude-focus-outline> <path class="segment" d="M50,50l25,43.3c-8,4.6-15.8,6.7-25,6.7V50z"/> <path class="overlay" d="M50,50l25,43.3c-8,4.6-15.8,6.7-25,6.7V50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(6,pm)]]" tabindex$="[[_canTab(6,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,6)]]" exclude-focus-outline> <path class="segment" d="M50,50v50c-9.2,0-17-2.1-25-6.7L50,50z"/> <path class="overlay" d="M50,50v50c-9.2,0-17-2.1-25-6.7L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(7,pm)]]" tabindex$="[[_canTab(7,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,7)]]" exclude-focus-outline> <path class="segment" d="M50,50L25,93.3C17,88.7,11.3,83,6.7,75L50,50z"/> <path class="overlay" d="M50,50L25,93.3C17,88.7,11.3,83,6.7,75L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(8,pm)]]" tabindex$="[[_canTab(8,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,8)]]" exclude-focus-outline> <path class="segment" d="M50,50L6.7,75C2.1,67,0,59.2,0,50H50z"/> <path class="overlay" d="M50,50L6.7,75C2.1,67,0,59.2,0,50H50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(9,pm)]]" tabindex$="[[_canTab(9,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,9)]]" exclude-focus-outline> <path class="segment" d="M50,50H0c0-9.2,2.1-17,6.7-25L50,50z"/> <path class="overlay" d="M50,50H0c0-9.2,2.1-17,6.7-25L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(10,pm)]]" tabindex$="[[_canTab(10,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,10)]]" exclude-focus-outline> <path class="segment" d="M50,50L6.7,25C11.3,17,17,11.3,25,6.7L50,50z"/> <path class="overlay" d="M50,50L6.7,25C11.3,17,17,11.3,25,6.7L50,50z"/> </g> <g class="segment-group" aria-label="[[_timeAriaLabel(11,pm)]]" tabindex$="[[_canTab(11,focusedSlice,small)]]" role="button" aria-pressed$="[[_isTicked(selected,11)]]" exclude-focus-outline> <path class="segment" d="M50,50L25,6.7C33,2.1,40.8,0,50,0V50z"/> <path class="overlay" d="M50,50L25,6.7C33,2.1,40.8,0,50,0V50z"/> </g> <circle class="background" cx="50" cy="50" r="0.5"/> </svg> </div> <template is="dom-if" if="[[!small]]"> <paper-icon-button id="toggleall" icon="all-out" aria-label$="[[_enableOrDisable(selected)]]" on-tap="_onToggleAllClick"></paper-icon-button> <paper-tooltip class="toggle-all-tooltip" position="top" for="toggleall" animation-delay="0" offset="0">[[_enableOrDisable(selected)]]</paper-tooltip> </template> </template> <script> Polymer({
      is: "duma-timewheel",

      properties: {
        starting: {
          type: String,
          value: null,
          observer: "_formatStarting"
        },
        selected: {
          type: Array,
          notify: true,
          observer: "_setFromArray"
        },
        pm: {
          type: Boolean,
          value: false
        },
        small: {
          type: Boolean,
          value: false
        },
        focusedSlice: {
          type: Number,
          value: 0
        }
      },

      _timeToString: function(time, pm) {
        // convert 0 - 11 to locale times, deciding between 0 or 12. 0 is actually 1, so add 1 to mod it
        var i = (time + 1) % 12;
        // convert to unix timestamp, of 0-24 hours. time * 3660 seconds * 1000 milliseconds
        var unixTime = (i + (pm ? 12 * 3600 * 1000 : 0)) * 3600 * 1000;
        // en-GB gets 12 pm as 0 pm. I talked with Andy, we decided that was weird. So there's an exception for en-GB to use en-US.
        var lang = navigator.language === "en-GB" ? "en-US" : navigator.language;
        // gmt timezone to avoid dst
        var timeString = new Date(unixTime).toLocaleTimeString(lang,{hour:"2-digit",hour12:true,timeZone:"Etc/GMT"});
        return parseInt(timeString);
      },

      _isTicked: function(selection,index) {
        return selection && selection[index] ? "true" : "false";
      },

      _timeAriaLabel: function(time,pm) {
        var comboText = pm ? "<%= i18n.format_pm_gap %>" : "<%= i18n.format_am_gap %>";
        if(time === 11) comboText = pm ? "<%= i18n.format_pm_gap_last %>" : "<%= i18n.format_am_gap_last %>";
        var t = comboText.format(this._timeToString(time-1), this._timeToString(time));
        return t;
      },

      get segments() {
        return this.$$(".wheel svg").querySelectorAll(".segment-group");
      },

      ready: function () {
        var sections = this.segments;
        for (var i = 0; i < sections.length; i++) {
          this.listen(sections[i], 'tap', '_onSectionClick');
          this.listen(sections[i], 'keydown', '_onSectionClick');
          sections[i].setAttribute('value', i + 1);
        }
      },

      _formatStarting: function (newValue) {
        if (this.starting != null) {
          this.selected = JSON.parse(this.starting);
        }
      },

      _reformatSelected: function () {
        if (!Array.isArray(this.selected)) {
          this.selected = [false, false, false, false, false, false, false, false, false, false, false, false];
        } else {
          var newSelect = [];
          for (var i = 0; i < 12; ++i) {
            newSelect.push(this.selected.includes(i + 1) || this.selected[i] == true);
          }
          this.selected = newSelect;
        }
      },

      _focusNextSlice: function(previous) {
        var next = (this.focusedSlice + (previous ? -1 : 1) ) % 12;
        if(next < 0) next += 12;
        this.focusedSlice = next;
        Polymer.RenderStatus.afterNextRender(this,() => {
          this.segments[next].focus();
        });
      },

      _onSectionClick: function (e) {
        if (!this.small) {
          if(e.code || e.key){
            // if space or enter, just preventDefault and continue to selection
            if(e.code === "Space" || e.code === "Enter") {
              e.preventDefault();
            }else{
              // e.key to allow for numpad use
              if(e.key === "ArrowLeft" || e.key === "ArrowUp"){
                this._focusNextSlice(true);
                e.preventDefault();
              }else if(e.key === "ArrowRight" || e.key === "ArrowDown"){
                this._focusNextSlice(false);
                e.preventDefault();
              }
              return;
            }
          }
          var segment = e.srcElement.tagName.toLowerCase() !== "g" ? e.srcElement.parentNode : e.srcElement;
          var index = parseInt(segment.getAttribute("value")) - 1;
          this._toggleSection(index);
        }
      },

      _doesToggleEnable: function(selected) {
        var falseCount = 0;
        var trueCount = 0;
        for(var i = 0; i < this.selected.length; i ++){
          if(this.selected[i]){
            trueCount ++;
          }else{
            falseCount ++;
          }
        }
        return trueCount <= falseCount;
      },

      // get text for if the toggle will enable or disable all
      _enableOrDisable: function(selected) {
        return this._doesToggleEnable(selected) ? "<%= i18n.enableAll %>" : "<%= i18n.disableAll %>";
      },

      _onToggleAllClick: function (e) {
        if (!this.small) {
          this.selected = new Array(12).fill(this._doesToggleEnable(this.selected));
        }
      },

      _toggleSection: function (index) {
        this._setSection(index, !this.selected[index]);
      },

      _setSection: function (index, bool) {
        var sel = this.selected.slice();
        sel[index] = bool;
        this.selected = sel;
      },

      _setFromArray: function (newArr) {
        if (newArr == null || newArr.length != 12) {
          this._reformatSelected();
        }
        else {
          var sections = this.$$(".wheel svg").children;
          for (var i = 0; i < sections.length; i++) {
            this.toggleClass("active", newArr[i], sections[i]);
          }
        }
      },
      
      _canTab: function(sliceIndex, focusedSlice, small){
        return small || sliceIndex !== focusedSlice ? -1 : 0;
      },
      
    }); </script> ​ </dom-module> 