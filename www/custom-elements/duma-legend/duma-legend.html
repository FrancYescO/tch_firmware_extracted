<link rel="import" href="/custom-elements/polymer/polymer.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-legend/duma-legend-item.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-flex-layout/iron-flex-layout.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <!--
  Creation:
  Created a legend designed to be placed to the side of a graph.
  To use you must provide an array (legendStats) following the examples structure where each element in the array corresponds to a statistic
  You can set this array with a jquery prop: $(dumaLegendSelector).prop("legendStats", config);

  Example data structure:
  {
    0:
    {
      label: "Download",
      result: "-",
      colour: "FFFFFF",
      visible: true,
      bgColour: "",
    },
    1:
    {
      label: "Upload",
      result: "-",
      colour: "FFFFFF",
      visible: true,
      bgColour: "",
    },
    2:
    {
      label: "Netflix Speed",
      result: "-",
      colour: "FFFFFF",
      visible: false,
      bgColour: "",
    }
  }

  Structure explanation:
  There are always 3 stats, you can hide the box icon by setting visible to false.
  You can set the label, result, border colour and fill colour of each statistic.

  Events:
  On click, the item on the legend will be struck through and an event will be fired.
  See duma-legend-item.html for more information about the event.

  Updating:
  If you want to update any part of the structure after initial config (for example when you get results to fill in)
  you can update each element with the set method.

  In this example index is an int representing which stat to update and the colour is the new value.
  summaryInfo is a local dom property being bound to legendStats

  setColour(index, colour)
  {
    var indexStr = index.toString();
    this.set(`summaryInfo.${indexStr}.colour`, colour);
    if (this.summaryInfo[indexStr].bgColour != "")
      this.set(`summaryInfo.${indexStr}.bgColour`, colour);
  }

  Moitoring click events:
  For monitoring click events you can listen to the "legendItemSelect" event. The details of the event contains a single int for the index of the toggled legend item
  This serves the purpose of allowing the user to show/hide corresponding graph data.

  An example for chartJS:

  // Replace LEGEND_ID with the id for this legend
  this.$.LEGEND_ID.addEventListener("legendItemSelect", function (value)
  {
    // Replace CHART_ID with the id for your graph
    var chart = this.$.CHART_ID.chart;

    // Toggle selected line, value.detail contains its line index
    var meta = chart.getDatasetMeta(value.detail);
    meta.hidden = meta.hidden === null ? !chart.data.datasets[value.detail].hidden : null;

    // Tells chartjs to update, otherwise the line will only update after some other update event (e.g. resizing)
    chart.update();
  }.bind(this)); // Binding "this" for selecting the chart within the method.
--> <dom-module id="duma-legend"> <template> <style is="custom-style" include="iron-flex"> :host {
        padding: 0 16px 8px;
        text-align: center;
        display: block;
      }
      :host[vertical] {
        text-align: left;
        min-width: 64px;
        max-width: 100%;
        padding-bottom: 16px;
        margin: auto 0;
      }
      :host[justified] {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
      }
      :host[justified][vertical] {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        margin: 0;
      }
      :host:not([justified]) > duma-legend-item {
        display: inline-flex;
      }
      :host:not([justified]):not([vertical]) > duma-legend-item {
        justify-content: center;
      }      
      :host[vertical] > duma-legend-item {
        display: block;
      }
      :host[vertical] > duma-legend-item:not(:first-child) {
        margin-top: 8px;
      }          
      :host:not([vertical]) > duma-legend-item:not(:first-child) {
        margin-left: 12px;
      }
      :host[chart-table-mode]:not([dont-hide-legend-in-table-mode]) {
        display: none !important;
      } </style> <!-- Legend Start --> <template is="dom-repeat" items="[[legendStats]]"> <duma-legend-item index="[[index]]" id$="item-[[index]]" stat="[[item]]" hide-stats="[[hideStats]]" left="[[vertical]]" colour-data="[[getColourData(index,item,item.*,_chartElem,_forceUpdateBool)]]"></duma-legend-item> </template> </template> <script> Polymer(
    {
      is: 'duma-legend',
      properties:
      {
        legendStats: Array,
        vertical: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        hideStats: {
          type: Boolean,
          value: false
        },
        noAutoBind: {
          type: Boolean,
          value: false
        },
        _forceUpdateBool: {
          type: Boolean,
          value: false
        },
        chartTableMode: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        dontHideLegendInTableMode: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        }
      },
      _chartElem: null,

      listeners: {
        "legendItemSelect": '_itemSelect'
      },

      ready: function(){
        if(!this.noAutoBind){
          var autoBind = $(this).parent().find("duma-chart")[0];
          if(autoBind){
            setTimeout(function(){
              this.bindToChart(autoBind);
            }.bind(this),10);
          }
        }
        this.chartTableMode = top.chartsAsTables;
      },

      //get the patterns used from the binded chart
      getCanvasPatterns: function(){
        var elem = this._chartElem;
        if(elem && elem.chart){
          var patterns = [];
          var data = elem.chart.data;
          for(var d = 0; data.datasets && d < data.datasets.length; d++){
            var dataset = data.datasets[d];
            var bg = dataset.backgroundColor;
            if(bg){
              if(bg instanceof CanvasPattern){
                patterns.push(bg);
              }else if(Array.isArray(bg) && bg[0] && bg[0] instanceof CanvasPattern){
                patterns.push.apply(patterns,bg);
              }
            }else{
              patterns.push(null);
            }
          }
          return patterns;
        }
        return [];
      },

      //get the colour data (colour or CanvasPattern)
      getColourData: function(index,item){
        var patterns = this.getCanvasPatterns()
        var ret = patterns[typeof item.patternIndex !== "undefined" ? item.patternIndex : index] || item.bgColour || false;
        return ret;
      },

      bindToChart: function(chart){
        if(!chart.chart){
          throw new Error("duma-legend chart elem does not have chart property");
        }else{
          this._chartElem = chart;
        }
      },

      _forceUpdate: function(){
        this._forceUpdateBool = !this._forceUpdateBool;
      },

      _itemSelect: function(event){
        if(this._chartElem){
          var type = this._chartElem.type;
          var chart = this._chartElem.chart;
          switch(type){
            case "pie":
            case "doughnut":
              //TODO support multiple datasets for pie and doughnuts
              var meta = chart.data.datasets[0]._meta;
              var key = Object.keys(meta)[0];
              var curr = meta[key].data[event.detail];
              curr.hidden = !curr.hidden;
              chart.update();
              break;
            case "bar":
            case "horizontalBar":
            case "line":
              var meta = chart.data.datasets[event.detail]._meta;
              var key = Object.keys(meta)[0];
              var curr = meta[key];
              curr.hidden = !curr.hidden;
              chart.update();
              break;
          }
        }
      }
    }); </script> </dom-module> 