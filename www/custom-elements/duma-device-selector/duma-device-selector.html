<!--
  (C) 2017 NETDUMA Software
  Kian Cross <kian.cross@netduma.com>
--> <link rel="import" href="../polymer/polymer.html"> <link rel="import" href="../paper-dialog/paper-dialog.html"> <link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html"> <link rel="import" href="../paper-listbox/paper-listbox.html"> <link rel="import" href="../paper-button/paper-button.html"> <link rel="import" href="../paper-item/paper-item.html"> <link rel="import" href="../paper-input/paper-input.html"> <link rel="import" href="../paper-icon-button/paper-icon-button.html"> <link rel="import" href="../iron-icon/iron-icon.html"> <link rel="import" href="../iron-icons/iron-icons.html"> <link rel="import" href="../paper-checkbox/paper-checkbox.html"> <link rel="import" href="../paper-radio-group/paper-radio-group.html"> <link rel="import" href="../paper-radio-button/paper-radio-button.html"> <link rel="import" href="../paper-input/paper-input.html"> <link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html"> <link rel="import" href="../paper-listbox/paper-listbox.html"> <link rel="import" href="../paper-item/paper-item.html"> <link rel="import" href="../iron-pages/iron-pages.html"> <link rel="import" href="../duma-alert/duma-alert.html"> <link rel="import" href="/libs/devices.html"> <link rel="import" href="/libs/jquery.html"> <link rel="import" href="/libs/q.html"> <link rel="import" href="/themes/<%= current_theme %>/duma-theme.html"> <dom-module id="duma-device-selector"> <style is="custom-style" include="duma-theme"></style> <template> <paper-dialog modal> <h2>[[ header ]]</h2> <div class="inner"> <template is="dom-if" if="[[_showServices]]"> <paper-radio-group selected="{{_selectedServicePage}}" on-iron-select="_notifyResize"> <paper-radio-button name="basic"><%= i18n.basic %></paper-radio-button> <paper-radio-button name="advanced"><%= i18n.advanced %></paper-radio-button> </paper-radio-group> </template> </div> <paper-dialog-scrollable> <template is="dom-if" if="[[!_showServices]]"> <paper-listbox selected="{{_selectedDevice}}" selected-item="{{_selectedDeviceItem}}" on-iron-items-changed="_notifyResize"> <template is="dom-repeat" items="[[_devices]]" as="device" sort="_sortDevices"> <template is="dom-if" if="[[_shouldDisplayDevice(_deviceTypes, device)]]"> <paper-item device-data="{{device}}">[[device.name]]</paper-item> </template> </template> </paper-listbox> </template> <template is="dom-if" if="[[_showServices]]"> <iron-pages selected="{{_getServicePage(_selectedServicePage)}}"> <div> <paper-listbox selected="{{_selectedServiceIndex}}" selected-item="{{_selectedServiceItem}}" on-iron-items-changed="_notifyResize"> <template is="dom-repeat" items="[[_services]]" as="service" sort="_sortServices"> <template is="dom-if" if="[[_shouldShowService(service, _tags)]]"> <paper-item class="service" service-data="[[service]]">[[service.application]]</paper-item> </template> </template> </paper-listbox> </div> <div class="inner"> <h3><%= i18n.sourcePort %></h3> <paper-input required type="number" min="1" max="65535" label="<%= i18n.startLabel %>" on-change="_onSourcePortMinChange" error-message="<%= i18n.invalidPortNumberError %>" value="{{_sourcePortMinValue}}" invalid="{{_sourcePortMinInvalid}}" auto-validate></paper-input> <paper-input type="number" required min="[[_sourcePortMinValue]]" max="65535" label="<%= i18n.endLabel %>" error-message="<%= i18n.invalidPortNumberError %>" invalid="{{_sourcePortMaxInvalid}}" value="{{_sourcePortMaxValue}}" auto-validate></paper-input> <h3><%= i18n.destinationPort %></h3> <paper-input required type="number" min="1" max="65535" label="<%= i18n.startLabel %>" value="{{_destinationPortMinValue}}" error-message="<%= i18n.invalidPortNumberError %>" on-change="_onDestinationPortMinChange" invalid="{{_destinationPortMinInvalid}}" value="{{_destinationPortMinValue}}" auto-validate></paper-input> <paper-input required type="number" min="[[_destinationPortMinValue]]" max="65535" label="<%= i18n.endLabel %>" error-message="<%= i18n.invalidPortNumberError %>" invalid="{{_destinationPortMaxInvalid}}" value="{{_destinationPortMaxValue}}" auto-validate></paper-input> <paper-dropdown-menu label="<%= i18n.protocol %>" required error-message="<%= i18n.protocolError %>" invalid="{{_protocolInvalid}}"> <paper-listbox class="dropdown-content" selected="{{_protocolValue}}" selected-item="{{_protocolItem}}"> <paper-item name="tcp">TCP</paper-item> <paper-item name="udp">UDP</paper-item> <paper-item name="tcpudp">TCP &amp; UDP</paper-item> </paper-listbox> </paper-dropdown-menu> </div> </iron-pages> </template> </paper-dialog-scrollable> <div class="buttons"> <paper-button id="cancel" dialog-dismiss><%= i18n.cancel %></paper-button> <template is="dom-if" if="[[_showAdvanced]]"> <paper-button on-tap="_onAdvancedClick" id="advanced">[[_getAdvancedButtonText(_showServices)]]</paper-button> </template> <paper-button id="ok" autofocus disabled="[[_nextButtonDisabled]]"> [[_getNextButtonText( _selectedService, _showServices, _selectedServicePage, _protocolValue)]]</paper-button> </div> </paper-dialog> <duma-alert id="duma-device-selector-alert"></duma-alert> </template> <script> Polymer({
      is: "duma-device-selector",
      
      properties: {
        _selectedServiceItem: {
          type: Object,
          value: null,
          observer: "_onSelectedServiceItemChange"
        },

        // IE11 doesn't seam to allow very long computed bindings
        // in the DOM so have created a computed property which is then
        // used in the DOM instead.
        _nextButtonDisabled: {
          computed: "_isNextButtonDisabled(_showServices, _selectedDevice, _selectedService, _selectedServicePage, _sourcePortMinInvalid, _sourcePortMaxInvalid, _destinationPortMinInvalid, _destinationPortMaxInvalid, _protocolInvalid, _sourcePortMinValue, _sourcePortMaxValue, _destinationPortMinValue, _destinationPortMaxValue, _protocolValue)"
        },

        header: {
          type: String,
          value: "<%= i18n.header %>"
        }
      },

      _sortServices: function (service1, service2) {
        if (service1.application < service2.application) {
          return -1;
        }

        if (service1.application > service2.application) {
          return 1;
        };
        
        return 0;
      },

      _sortDevices: function (device1, device2) {
        if (device1.name < device2.name) {
          return -1;
        }

        if (device1.name > device2.name) {
          return 1;
        };
        
        return 0;
      },

      _updateServices: function () {
        this._servicesPromise = Q($.getJSON(
          "/json/_services_.json?cache=0",
          function (services) {
            this._services = services;
          }.bind(this)
        ));
      },

      _shouldShowService: function (service, tags) {
        for (var i = 0; i < tags.length; i++) {
          if (service.tags.indexOf(tags[i]) === -1) {
            return false;
          }
        }

        return true;
      },

      _onSelectedServiceItemChange: function () {
        if (this._selectedServiceItem
            && typeof(this._selectedServiceItem) == "object") {

          this._selectedService = this._selectedServiceItem.serviceData;
        }
      },

      _onSourcePortMinChange: function () {
        this._sourcePortMaxValue = this._sourcePortMinValue;
      },
      
      _onDestinationPortMinChange: function () {
        this._destinationPortMaxValue = this._destinationPortMinValue;
      },

      _getAdvancedButtonText: function (showServices) {
        if (showServices) {
          return "<%= i18n.devices %>";
        } else {
          return "<%= i18n.advanced %>";
        }
      },

      _notifyResize: function () {
        this.$$("paper-dialog").notifyResize();
      },

      _getServicePage: function (selectedServicePage) {
        return ["basic", "advanced"].indexOf(selectedServicePage);
      },

      _getNextButtonText: function (
        selectedService, showServices,
        selectedServicePage, protocolValue
      ) {
        if (
          (selectedService || showServices)
          && !(selectedServicePage == "advanced" 
               && protocolValue == -1 && !showServices)
        ) {
          return "<%= i18n.done %>";
        } else {
          return "<%= i18n.next %>";
        }
      },

      _isNextButtonDisabled: function (
        showServices, selectedDevice, selectedService, selectedServicePage,
        sourcePortMinInvalid, sourcePortMaxInvalid, destinationPortMinInvalid,
        destinationPortMaxInvalid, protocolInvalid, sourcePortMinValue,
        sourcePortMaxValue, destinationPortMinValue, destinationPortMaxValue,
        protocolValue
      ) {
        if (showServices) {
          switch (selectedServicePage) {
            case "basic":
              if (selectedService && selectedDevice > -1) {
                return false;
              }
              break;

            case "advanced":
              if (
                !sourcePortMinInvalid && !sourcePortMaxInvalid
                && !destinationPortMinInvalid && !destinationPortMaxInvalid
                && !protocolInvalid && sourcePortMinValue != ""
                && sourcePortMaxValue != "" && destinationPortMinValue != ""
                && destinationPortMaxValue != "" && protocolValue > -1
                && selectedDevice > -1
              ) {
                return false;
              }
              break;
          } 
        } else {
          if (selectedDevice > -1) {
            return false;
          }
        }

        return true;
      },

      _shouldDisplayDevice: function (deviceTypes, device) {
        return device.id > 0;

        for (var i = 0; i < deviceTypes.length; i++) {
          if (
            deviceTypes[i] == "*"
            || deviceTypes[i].toUpperCase() == type.toUpperCase()
          ) {
            return true;
          }
        }
        return false;
      },

      _refreshDevices: function( d ) {
        var that = this;

        function do_refresh( devices ){
          var processedDevices = [];
          for (var id in devices) {
            if (devices.hasOwnProperty(id)) {
              processedDevices.push(devices[id]);
            }
          }
          that._devices = processedDevices;
        }

        if( d )
          do_refresh( d );
        else
          get_devices().done( do_refresh );
      },

      _removeEventListeners: function () {
        $(this.$$("paper-button#ok")).off("click");
        $(this.$$("paper-button#cancel")).off("click");
      },

      _onAdvancedClick: function () {
        this._showServices = !this._showServices;
        this._notifyResize();
      },

      _getProtocolNumber: function (protocol) {
        return {
          "tcp": 6,
          "udp": 17
        }[protocol];
      },

      _generateService: function (protocol) {
        return {
          sport: [
            parseInt( this._sourcePortMinValue ),
            parseInt( this._sourcePortMaxValue )
          ],
          dport: [
            parseInt( this._destinationPortMinValue ),
            parseInt( this._destinationPortMaxValue )
          ],
          proto: this._getProtocolNumber(protocol)
        };
      },

      _generateAdvancedServiceName: function (protocol, sport, dport) {
        return protocol.toUpperCase() +
               " - <%= i18n.sourcePort %> (" + sport[0] + ":" + sport[1] + ")" +
               " - <%= i18n.destinationPort %> (" + dport[0] + ":" + dport[1] + ")";
      },

      _getService: function () {
        switch (this._selectedServicePage) {
          case "basic":
            if (this._selectedService) {
              return this._selectedService;
            }
            break;

          case "advanced":
            switch ($(this._protocolItem).attr("name")) {
              case "tcp":
              case "udp":
                var service = this._generateService(
                  $(this._protocolItem).attr("name")
                );

                return {
                  application: this._generateAdvancedServiceName(
                    $(this._protocolItem).attr("name"),
                    service.sport,
                    service.dport
                  ),
                  custom: true,
                  services: [service]
                };
                break;

              case "tcpudp":
                var tcpService = this._generateService("tcp");
                var udpService = this._generateService("udp");

                return {
                  application: this._generateAdvancedServiceName(
                    "tcpudp",
                    tcpService.sport,
                    tcpService.dport
                  ),
                  custom: true,
                  services: [tcpService, udpService]
                };
                break;
            }
            break;
        }
      },

      _resetAdvancedSevice: function () {
        this._sourcePortMinValue = 1;
        this._sourcePortMaxValue = 65535;
        this._destinationPortMinValue = "";
        this._destinationPortMaxValue = "";
        this._protocolValue = -1;

        this._sourcePortMinInvalid = false;
        this._sourcePortMaxInvalid = false;
        this._destinationPortMinInvalid = false;
        this._destinationPortMaxInvalid = false;
        this._protocolInvalid = false;
      },

      _reset: function (deviceTypes, defaultService, tags) {
        this._deviceTypes = deviceTypes;
        this._selectedDevice = -1;
        this._selectedServiceItem = null;
        this._showServices = false;
        this._removeEventListeners();
        this._showAdvanced = false;
        this._selectedServicePage = "basic";
        this._selectedService = defaultService;
        this._selectedServiceIndex = -1;
        this._resetAdvancedSevice();
        this._tags = tags;
      
        if (defaultService)  {
          this._showAdvanced = true;
        } 
      },
      
      ready: function () {
        this._refreshDevices();
        this._updateServices();
      },

      open: function (deviceTypes, defaultService, tags, callback, devices) {
        
        // Remap optional parameters.
        switch (typeof(tags)) {
          case "function":
            callback = tags;
            tags = null;
            break;
        }

        switch (typeof(defaultService)) {
          case "string":
            tags = defaultService;
            defaultService = null;
            break;
          case "function":
            callback = defaultService;
            defaultService = null;
            break;
        }

        this._refreshDevices( devices );
        this._reset(deviceTypes, defaultService, tags);
        this.$$("paper-dialog").open();

        $(this.$$("paper-button#cancel")).click(function () {
          this._removeEventListeners();
        }.bind(this));

        $(this.$$("paper-button#ok")).click(function () {
          if (this._getService()) {
            if (typeof(callback) == "function") {
              var service = this._getService();
              callback(
                this._selectedDeviceItem.deviceData,
                service.services,
                service.application,
                service.custom ? true : false
              );
            }
            this._removeEventListeners();
            this.$$("paper-dialog").close();
          } else {
            this._showServices = true;
          }

          this._notifyResize();
        }.bind(this));
      },

      getServices: function () {
        return this._servicesPromise;
      },

      getServiceById: function (id) {
        var services = this._services;
        for (var i = 0; i < services.length; i++) {
          var service = services[i];

          if (service.services) {
            
            for (var p = 0; p < service.services.length; p++) {
              if (service.services[p].appid === id) {
                return service;
              }
            }
          }

        }
      }
    }); </script> </dom-module> 