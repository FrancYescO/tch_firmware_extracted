<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <style>
      .info-box {
        background-color: lightgray;
        width: 100%;
      }
      button {
        background-color: lightgray;
        border: none;
        padding: 4px 4px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        transition-duration: 0.4s;
      }
      button.accent {
        float:right;
      }
      button:hover {
        background-color: <%= theme.DARK_PRIMARY_COLOR %>; /* Green */
        color: <%= theme.PRIMARY_TEXT_COLOR %>;
      }
      button.accent:hover {
        background-color: <%= theme.DARK_ACCENT_COLOR %>; /* Green */
      }
      div[hidden] {
        display: none;
      }
    </style>
  </head>
  <%
    require("libos")
    local platform = os.platform_information()
    
    local enabledir
    if platform.model == "XR1000" then
      enabledir = "/misc2/ddt/"    -- directory used for enable/disable files
    else
      enabledir = "/dumaos/ddt/"    -- directory used for enable/disable files not read only
    end

    local rapps = {}
    local function scan_dirs(path)
      local p = io.popen(string.format("echo %s/* | tr ' ' '\n'",path),"r")
      if not p then
        return
      end
      for dir in p:lines() do
        local rapp = dir:match(path .. "/(.+)")
        local path = enabledir .. rapp
        local enabled = os.execute(string.format([[test "$(cat "%s")" = "true"]],path)) == 0
        table.insert(rapps,{
          rapp = rapp,
          enabled = enabled
        })
      end
      p:close()
    end
    scan_dirs("/dumaos/apps/usr")
    scan_dirs("/dumaos/apps/system")
  %>
  <script type="text/javascript" src="/nd-js/jquery.js"></script>
  <body>
    <input type="checkbox" autocomplete="off" onchange="submitAll(this.checked)" /> <label for="enabled">Enable Tracing for all</label>
    <hr/>
    <% for index,data in ipairs(rapps) do %>
      <input type="checkbox" autocomplete="off" rapp="<%= data.rapp %>" <%= data.enabled and "checked " or "" %>onchange="submit(this.checked,'<%= data.rapp %>')" /> <label for="enabled">Enable Tracing for <%= data.rapp %></label>
      <br/>
    <% end %>
    <hr/>
    <button type="button" onclick="get()">Refresh</button>
    <h2>OUTPUT</h2>
    <pre class="info-box" rapp="ALLOFTHEM">
    </pre>
      
    <script>
      function submit(val,rapp){
        console.log(val,rapp)
        $.post("/desktop/ddt_back.html",{ method:"set_trace", rapp:rapp, is_tracing: val });
      }
      function submitAll(val){
        $("input[rapp]").each(function(index,element){
          submit(val,element.attributes.rapp.value)
          $(element).attr("checked", val);
        });
      }
      function setPre(text){
        $("pre.info-box").text(text);
      }
      function get(rapp){
        $.post("/desktop/ddt_back.html",{ method:"get_log" }, function(result){
          setPre(result);
        });
      }
      function hide(rapp){
        $("div[rapp="+rapp+"]").each(function(index,element){
          $(element).attr("hidden",$(element).attr("hidden") ? null : true)
        });
      }
      get();
      // setTimeout(function() { location.reload(true); }, 5000);
    </script>
  </body>
</html>