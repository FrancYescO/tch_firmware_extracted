<!--
  (C) 2020 NETDUMA Software
  Luke Meppem
--> <link rel="import" href="/custom-elements/polymer/polymer.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-icon/iron-icon.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-icons/iron-icons.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-spinner/paper-spinner-lite.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-input/paper-input.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-flex-layout/iron-flex-layout-classes.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/iron-flex-layout/iron-flex-layout.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-dialog/paper-dialog.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-dialog-scrollable/paper-dialog-scrollable.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-dropdown-menu/paper-dropdown-menu.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-radio-button/paper-radio-button.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-radio-group/paper-radio-group.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-checkbox/paper-checkbox.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-tabs/paper-tabs.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-tabs/paper-tab.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-listbox/paper-listbox.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-item/paper-item.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/paper-toast/paper-toast.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-image/duma-image.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-chart/duma-chart.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/custom-elements/duma-clipboard-button/duma-clipboard-button.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/themes/<%= current_theme %>/duma-theme.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/libs/cycle.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/libs/rpc.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/libs/storage.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <link rel="import" href="/libs/colours.html?v=<%= dumaos_version %>&lang=<%= lang %>&theme=<%= current_theme %>&themeVersion=<%= current_theme_version %>"> <dom-module id="rapp-overview"> <template> <style is="custom-style" include="duma-theme iron-flex iron-positioning"> :host #dialog {
        width: calc(100vw - 20em) !important;
        max-width: 100vw !important;
      }

      .row,
      .rapp-row {
        display: flex;
        flex-direction: row;
      }

      .margin-bottom {
        margin-bottom: 2em;
      }

      .rapp-row {
        align-items: center;
      }

      .pointer {
        cursor: pointer;
      }

      .graph-wrapper {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        width: 100em;
        height: 30em;
      }

      .mini-graph-wrapper {
        display: flex;
        flex-direction: column;
        width: 50%;
        height: 10em;
      }

      .x-axis-label {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: -1em;
      }
      .x-axis-label > *:first-child {
        margin-left: 108px;
      }
      .top-bar {
        align-items: flex-end;
        margin-bottom: 1em;
      }
      .top-bar > *:not(:first-child){
        margin-left: 2em;
      }

      .legend {
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 19em;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .legend-scroll {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .legend-scroll .rapp-row>span {
        display: inline-block;
        min-width: 16px;
        min-height: 12px;
        margin-right: 5px;
      }

      .legend-scroll .rapp-row {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }

      .expand {
        display: flex;
        justify-content: space-between;
        width: 100%;
      }

      .radios {
        margin-bottom: 16px;
      }

      .radios > *:nth-child(n+2) {
        margin-left: 16px;
      }

      .pages > iron-page > div {
        max-height: 60vh;
      }

      .advanced-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        justify-content: space-around;
      }

      .advanced-info .row > div {
        display: flex;
        flex-direction: row;
        flex-grow: 1;
        justify-content: space-between;
        margin-right: 10em;
        margin-left: 2em;
        width: 50%;
      }

      .table-container {
       height: 50vh;
       overflow: auto;
      }
      .scroll-table {
        height: 100%;
      }
      .scroll-table thead th:nth-child(n+2) {
        cursor: pointer;
      }
      .scroll-table tbody tr:nth-of-type(2n) {
        background-color: var(--divider-color);
      }
      .time-width {
        margin-top: -2.5em;
      }
      .system-info-header {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: baseline;
        margin-bottom: 1em;
      }
      .system-info-header > div {
        margin-left: 1.2em;
      }
      .system-info-header > div:first-child {
        margin-left: 18px;
      }
      :host:not([show-system-info]) .system-info-header > div:first-child:not(:hover) paper-checkbox {
        opacity: 0;
      }
      .system-info-header > .right {
        margin-left: auto !important;
      }
      .system-info-header > div > span:first-child {
        color: var(--secondary-text-color);
        margin-right: 0.3em;
      }
      .buttons .left {
        margin-right: auto;
      } </style> <paper-dialog id="dialog" with-backdrop> <h2 dialog-label><%= i18n.rappPerformance %></h2> <div class="inner"> <div class="margin-bottom"> <paper-tabs selected="{{_selectedTab}}" attr-for-selected="name"> <paper-tab name="memory"><%= i18n.memoryUsage %></paper-tab> <!-- <paper-tab name="cpu"><%= i18n.cpuUsage %></paper-tab> --> <paper-tab name="advanced"><%= i18n.advanced %></paper-tab> </paper-tabs> </div> <iron-pages selected="[[_selectedPage]]" attr-for-selected="name" class="pages"> <iron-page name="single"> <div class="row top-bar"> <paper-dropdown-menu class="time-width" label="<%= i18n.timeSpan %>" aria-label="<%= i18n.timeSpan %>"> <paper-listbox class="dropdown-content" selected="{{_selectedTimespan}}" aria-label="<%= i18n.timeSpan %>"> <template is="dom-repeat" items="[[timespans]]"> <paper-item>[[_formatTimespan(item)]]</paper-item> </template> </paper-listbox> </paper-dropdown-menu> <div class="grow"> <paper-checkbox checked="{{_enableInBackground}}"><%= i18n.enableBackground %></paper-checkbox> </div> </div> <div class="row"> <div class="graph-wrapper"> <duma-chart id="chart" type="line" options="[[__gOptions]]" data="[[__gData]]"></duma-chart> <template is="dom-if" if="[[!tableMode]]"> <div class="x-axis-label"> <span>[[_formatTimespanAgo(_selectedTimespan)]]</span> <span><%= i18n.now %></span> </div> </template> </div> <div class="legend"> <div> <paper-dropdown-menu id="dropdown" label="<%= i18n.selectRapps %>" aria-label="<%= i18n.selectRapps %>"> <div class="rapp-list inner dropdown-content"> <template is="dom-repeat" items="[[rapps]]" as="rapp"> <div class="rapp-row pointer" on-click="_onRappRowClick" rapp="[[rapp]]"> <!-- <div>
                        <template is="dom-if" if="[[rapp.icon]]">
                          <duma-image src="[[rapp.icon]]" style$="[[_genRowStyle(index)]]"></duma-image>
                        </template>
                        <template is="dom-if" if="[[!rapp.icon]]">
                          <iron-icon icon="help" style$="[[_genRowStyle(index)]]"></iron-icon>
                        </template>
                      </div> --> <paper-checkbox checked="[[_isRappSelected(rapp,_selectedRappsLength)]]" disabled="[[_selectableDisabled(rapp,_selectedRappsLength)]]"> <template is="dom-if" if="[[rapp.name]]"> [[rapp.name]] </template> <template is="dom-if" if="[[!rapp.name]]"> [[rapp.id]] </template> </paper-checkbox> </div> </template> </div> </paper-dropdown-menu> </div> <paper-radio-group selected="{{_selectedData}}" attr-for-selected="name" class="radios" aria-label="<%= i18n.ariaMemoryRadioLabel %>"> <paper-radio-button name="totalbytes"><%= i18n.typeTotal %></paper-radio-button> <paper-radio-button name="memory"><%= i18n.typeMemory %></paper-radio-button> </paper-radio-group> <ul class="legend-scroll"> <template is="dom-repeat" items="[[_getSelected(_selectedRappsLength)]]" as="rapp"> <li class="rapp-row" rapp="[[rapp]]"> <span style$="[[_genLegendStyle(index)]]"></span> <div class="expand horizontal"> <template is="dom-if" if="[[rapp.name]]"> <span> [[rapp.name]] </span> </template> <template is="dom-if" if="[[!rapp.name]]"> <span> [[rapp.id]] </span> </template> <span class="currentByteShow" rapp="[[rapp.id]]">0B</span> </div> </li> </template> </ul> </div> </div> </iron-page> <iron-page name="advanced"> <div class="system-info-header"> <div> <paper-checkbox id="systemToggle" checked="{{showSystemInfo}}"><%= i18n.showKernelValues %></paper-checkbox> </div> <template is="dom-if" if="[[showSystemInfo]]"> <template is="dom-repeat" items="[[systemInfos]]" as="info"> <div> <span>[[info.name]]:</span> <span>[[_systemValueFormat(info.value,systemInfoAsRaw)]]</span> </div> </template> </template> <div class="right"> <paper-checkbox checked="{{systemInfoAsRaw}}"><%= i18n.showRawValues %></paper-checkbox> <duma-clipboard-button id="clipboardButton"></duma-clipboard-button> </div> </div> <!-- TODO convert to use duma-table --> <div class="table-container"> <table class="scroll-table"> <thead> <tr> <th></th> <th sort="default" on-click="_sortClick"><%= i18n.rappName %><iron-icon icon="[[_getSortIcon('default',_sortMethod,_sortAscending)]]"></iron-icon></th> <template is="dom-repeat" items="[[__columns]]" as="col"> <th sort$="[[col.key]]" on-click="_sortClick">[[col.display]]<iron-icon icon="[[_getSortIcon(col.key,_sortMethod,_sortAscending)]]"></iron-icon></th> </template> </tr> </thead> <tbody> <template is="dom-repeat" items="[[rapps]]" as="rapp" sort="[[_getSortMethod(_sortMethod,_sortAscending)]]"> <tr class="advanced-row" rapp="[[rapp]]"> <td> <template is="dom-if" if="[[rapp.icon]]" restamp> <duma-image src="[[rapp.icon]]"></duma-image> </template> <template is="dom-if" if="[[!rapp.icon]]"> <iron-icon icon="info"></iron-icon> </template> </td> <td>[[rapp.name]]</td> <template is="dom-repeat" items="[[__columns]]" as="col"> <td><div>[[_getAdvancedInfo(col.key,rapp,__sortInfo,systemInfoAsRaw)]]</div></td> </template> </tr> </template> </tbody> </table> </div> </iron-page> </iron-pages> </div> <div class="buttons"> <paper-button dialog-dismiss><%= i18n.close %></paper-button> </div> </paper-dialog> </template> <script> Polymer({
      is: "rapp-overview",

      properties: {
        _cycle: {
          type: Object,
          value: null
        },
        rapps: {
          type: Object,
          value: []
        },
        _selectedRapps: {
          type: Object,
          value: [],
          observer: "_updateSelRappsLength"
        },
        _selectedRappsLength: {
          type: Number,
          value: 0,
          observer: "_updateLineColours"
        },
        _maxSelected: {
          type: Number,
          value: 8
        },
        _memData: {
          type: Object,
          value: {
            totalbytes: {},
            estimates: {},
            memory: {},
          }
        },
        _selectedData: {
          type: String,
          value: "totalbytes",
          observer: "_selectedDataChanged"
        },
        _selectedPage: {
          type: String,
          value: "single",
          observer: "_selectedDataChanged"
        },
        _selectedTab: {
          type: String,
          value: "memory",
          observer: "_selectedDataChanged"
        },
        timespans: {
          type: Array,
          value:[
            20,
            40,
            60,
            100,
            200,
            400,
          ]
        },
        _selectedTimespan: {
          type: Number,
          value: null,
          observer: "_selectedTimespanChanged"
        },
        _enableInBackground: {
          type: Boolean,
          value: null,
          observer: "_enableBackgroundChanged"
        },
        _timeCount: {
          type: Number,
          value: 0
        },

        _sortMethod: {
          type: String,
          value: "default",
          observer: "_sortMethodChanged"
        },
        _sortAscending: {
          type: Boolean,
          value: false
        },
        __sortInfo: {
          type: Object,
          value: {}
        },
        showSystemInfo: {
          type: Boolean,
          value: null,
          observer: "_showSystemInfoChanged",
          reflectToAttribute: true
        },
        systemInfos: {
          type: Array,
          value: []
        },
        systemInfoAsRaw: {
          type: Boolean,
          value: false
        },

        __gOptions: Object,
        __gData: Object,
        __shades: Array,
        __prePage: String,

        __columns: {
          type: Object,
          value: [
            {key: "peak-size", display: "<%= i18n.vmemSize %>"},
            {key: "peak-peak", display: "<%= i18n.vmemPeak %>"},
            {key: "current-p", display: "<%= i18n.currentPSS %>"},
            {key: "current-r", display: "<%= i18n.currentRSS %>"},
            {key: "current-vmach", display: "<%= i18n.currentVMach %>"},
            {key: "peak-vmach", display: "<%= i18n.peakVMach %>"},
          ]
        },

        tableMode: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        }
      },

      _sortingMethods: {
        ["default"]: function(a,b,info){
          return a.name > b.name ? 1 : -1;
        },
        ["peak-size"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].vm_size;
          var valB = info[b.id].vm_size;
          return valA - valB;
        },
        ["peak-peak"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].vm_peak;
          var valB = info[b.id].vm_peak;
          return valA - valB;
        },
        ["current-p"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].vm_pss;
          var valB = info[b.id].vm_pss;
          return valA - valB;
        },
        ["current-r"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].vm_rss;
          var valB = info[b.id].vm_rss;
          return valA - valB;
        },
        ["current-vmach"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].totalbytes;
          var valB = info[b.id].totalbytes;
          return valA - valB;
        },
        ["peak-vmach"]: function(a,b,info){
          if(!info[a.id]) return 1;
          if(!info[b.id]) return -1;
          var valA = info[a.id].totalbytes_max;
          var valB = info[b.id].totalbytes_max;
          return valA - valB;
        },
      },

      _formatTimespan: function(time){
        if(time * this._refreshInterval >= 120){
          return this._format("<%= i18n.agoM %>",(time * this._refreshInterval) / 60);
        }else{
          return this._format("<%= i18n.agoS %>",(time * this._refreshInterval));
        }
      },
      _formatTimespanAgo: function(){
        var time = this._getTimespan();
        if(time * this._refreshInterval >= 120){
          return this._format("<%= i18n.longAgoM %>",(time * this._refreshInterval) / 60);
        }else{
          return this._format("<%= i18n.longAgoS %>",(time * this._refreshInterval));
        }
      },
      _getTimespan: function(){
        return this.timespans[this._selectedTimespan];
      },

      _getSortIcon: function(thisMethod,method,ascending){
        if(thisMethod !== method)
          return "blank";
        else {
          return ascending ? "arrow-drop-up" : "arrow-drop-down";
        }
      },

      _getSortMethod: function(method,ascending){
        return function(a,b){
          if(this._sortingMethods[method]){
            var args = [a,b,this.__sortInfo || {}];
            return ((ascending === true) ? 1 : -1) * this._sortingMethods[method].apply(this,args);
          }else{
            return 0;
          }
        }.bind(this);
      },

      _sortMethodChanged: function(){
        this._sortAscending = false;
      },

      _sortClick: function(e){
        var sort = $(e.target).closest("[sort]").attr("sort") || "default";
        if(this._sortMethod !== sort){
          this._sortAscending = false;
          this._sortMethod = sort;
        }else{
          this._sortAscending = !this._sortAscending;
        }
      },

      _selectableDisabled: function(rapp,count){
        if(count < this._maxSelected) return false;
        for(var i = 0; i < this._selectedRapps.length; i ++){
          var srapp = this._selectedRapps[i];
          if(srapp.id === rapp.id){
            return false;
          }
        }
        return true;
      },

      _format: function () {
        return String.format.apply(this, arguments);
      },

      _selectedTimespanChanged: function(newVal){
        var storageNameSpace = "com.netdumasoftware.rappoverview";
        var storageNameKey = "timespan";
        if(newVal !== null){
          duma.storage(storageNameSpace,storageNameKey,newVal);
        }else{
          this._selectedTimespan = Math.min(parseInt(duma.storage(storageNameSpace,storageNameKey)),this.timespans.length - 1) || 0;
        }
      },
      _enableBackgroundChanged: function(newVal){
        var storageNameSpace = "com.netdumasoftware.rappoverview";
        var storageNameKey = "enableBackground";
        if(newVal !== null){
          duma.storage(storageNameSpace,storageNameKey,newVal);
        }else{
          this._enableInBackground = duma.storage(storageNameSpace,storageNameKey) === "true";
        }
      },
      _showSystemInfoChanged: function(newVal){
        var storageNameSpace = "com.netdumasoftware.rappoverview";
        var storageNameKey = "showSystemInfo";
        if(newVal !== null){
          duma.storage(storageNameSpace,storageNameKey,newVal);
        }else{
          this.showSystemInfo = duma.storage(storageNameSpace,storageNameKey) === "true";
        }
      },

      ready: function () {
        this.tableMode = top.chartsAsTables;
        this._setGraphOptions();
        this.__shades = getAllShades();
        this._maxSelected = this.__shades.length;
        this._refreshLoop();
        this.$.clipboardButton.getText = this._getClipboardText.bind(this);
      },

      _getSelected: function () {
        return this._selectedRapps.map((x) => x);
      },

      _getColor: function (num) {
        return this.__shades[num % this.__shades.length];
      },

      _genRowStyle: function (index) {
        return ("fill:{0};".format(this._getColor(index)));
      },
      _genLegendStyle: function (index) {
        return "background-color:{0};".format(this._getColor(index));
      },

      _updateDropdownLabel: function () {
        $(this.$.dropdown.$menuButton).find("paper-input")[0].value = "<%= i18n.selectedCount %>".format(this._selectedRappsLength);
      },

      _updateSelRappsLength: function () {
        this._selectedRappsLength = this._selectedRapps ? this._selectedRapps.length : 0;
        this._updateLineColours();
        this._updateDropdownLabel();
      },

      _getRappObject: function (rappOrRappID, list) {
        if (!list) { list = this.rapps; }
        for (var i = 0; i < list.length; i++) {
          var test = list[i];
          if (test === rappOrRappID || test.id === rappOrRappID || test.id === rappOrRappID.id) {
            return test
          }
        }
      },

      _isRappSelected: function (rapp, length) {
        return this._getRappObject(rapp, this._selectedRapps) ? true : null;
      },

      _addRappToSelected: function (rapp) {
        rapp = this._getRappObject(rapp);
        this._selectedRapps.push(rapp);
        this._updateSelRappsLength();
      },
      _removeRappFromSelected: function (rapp) {
        for (var i = this._selectedRapps.length - 1; i >= 0; i--) {
          var sel = this._selectedRapps[i];
          if (sel === rapp || sel.id === rapp.id || sel.id === rapp) {
            this._selectedRapps.splice(i, 1);
          }
        }
        this._updateSelRappsLength();
      },
      _toggleSelected: function (rapp) {
        if (this._isRappSelected(rapp)) {
          this._removeRappFromSelected(rapp);
        } else {
          this._addRappToSelected(rapp);
        }
      },

      _onRappRowClick: function (e) {
        var row = $(e.target).closest(".rapp-row")[0];
        if (row && row.rapp) {
          if(!this._selectableDisabled(row.rapp,this._selectedRappsLength)){
            this._toggleSelected(row.rapp);
          }
        }
      },

      _formatBytes: function (value) {
        return format_bytes(value, 1);
      },

      _setGraphOptions: function () {
        this.__gOptions = {
          animation: {
            duration: 0
          },
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true,
                callback: this._formatBytes,
                precision: 0
              },
              scaleLabel: {
                display: true,
                labelString: "<%= i18n.yAxisLabel %>"
              }
            }],
            xAxes: [{
              type: 'time',
              time: {
                minUnit: 'second',
              },
              ticks: {
                autoSkip: true,
                display: false,
              },
              offset: false,
              display: true,
              distribution: 'linear',
              stacked: true,
              scaleLabel: {
                display: false,
                labelString: "<%= i18n.rappName %>"
              }
            }]
          },
          elements: {
            line: {
              tension: 0.1
            },
            point: {
              pointStyle: 'circle',
              radius: 0,
              hitRadius: 3,
            }
          },
          legend: {
            display: false
          }
        }
      },

      _update: function () {
        if (this.$.chart.chart) {
          var axis = this.$.chart.chart.config.options.scales.xAxes[0].ticks;
          axis.min = this._timeCount - (this._getTimespan() - 1);
          axis.max = this._timeCount;
          this.$.chart.chart.update();
        }
      },

      _getEstimColor: function (color) {
        return new Color(color).setVal(64, 3).hex()
      },

      _updateLineColours: function () {
        for (var i = 0; i < this._selectedRapps.length; i++) {
          var rapp = this._selectedRapps[i];
          if (this._memData.totalbytes[rapp.id]) {
            var color = this._getColor(i);
            function __setCol__(obj){
              obj.borderColor = color;
              obj.pointBorderColor = color;
              obj.pointBackgroundColor = color;
            }
            __setCol__(this._memData.totalbytes[rapp.id]);
            __setCol__(this._memData.estimates[rapp.id]);
            __setCol__(this._memData.memory[rapp.id]);
          }
        }
        this._update();
      },

      _initEmptyData: function () {
        return [];
      },

      _initData: function (rapp, index) {
        var color = this._getColor(index);
        var ariaValueFormatter = function(val){
          var value = val && typeof val.y !== "undefined" ? val.y : val;
          return value && format_bytes(value, 1);
        }
        this._memData.totalbytes[rapp.id] = {
          label: rapp.name,
          borderColor: color,
          pointBorderColor: color,
          pointBackgroundColor: color,
          backgroundColor: 'transparent',
          type: 'line',
          data: this._initEmptyData(),
          ariaValueFormatter: ariaValueFormatter
        }
        this._memData.estimates[rapp.id] = {
          label: rapp.name,
          borderColor: color,
          pointBorderColor: color,
          pointBackgroundColor: color,
          backgroundColor: 'transparent',
          type: 'line',
          data: this._initEmptyData(),
          ariaValueFormatter: ariaValueFormatter
        }
        this._memData.memory[rapp.id] = {
          label: rapp.name,
          borderColor: color,
          pointBorderColor: color,
          pointBackgroundColor: color,
          backgroundColor: 'transparent',
          type: 'line',
          data: this._initEmptyData(),
          ariaValueFormatter: ariaValueFormatter
        }
        return [this._memData.totalbytes[rapp.id], this._memData.estimates[rapp.id], this._memData.memory[rapp.id]];
      },

      _clampAndClone: function (data) {
        if(!data || !data.data) return {data:[]}
        while (data.data.length > this._getTimespan()) {
          data.data.shift()
        }
        var clone = Object.assign({}, data);
        clone.data = data.data.map(function (val) {
          return val;
        });
        return clone;
      },

      _addData: function (rapp, memInfo, index) {
        var datas = {
          totalbytes: this._memData.totalbytes[rapp.id] || this._initData(rapp, index)[0],
          estimates: this._memData.estimates[rapp.id] || this._initData(rapp, index)[1],
          memory: this._memData.memory[rapp.id] || this._initData(rapp, index)[2]
        }
        if (memInfo.totalbytes) datas.totalbytes.data.push({ t: this._timeCount, y: parseInt(memInfo.totalbytes) });
        if (memInfo.estimate) datas.estimates.data.push({ t: this._timeCount, y: parseInt(memInfo.estimate) });
        if (memInfo.vm_pss || memInfo.vm_rss) datas.memory.data.push({ t: this._timeCount, y: parseInt((memInfo.vm_pss || memInfo.vm_rss) * 1024) });
        return this._getSingleData(rapp);
      },

      _getSingleData: function (rapp) {
        return [this._clampAndClone(this._memData[this._selectedData][rapp.id])];
      },

      _setCurrentShow: function (rapp, list, datasets) {
        for (var i = 0; i < list.length; i++) {
          var elem = list[i];
          if ((elem.rapp === rapp.id || elem.rapp === rapp)) {
            if (datasets[0] && datasets[0].data.length) {
              var data = datasets[0].data[datasets[0].data.length - 1].y || 0;
              $(elem).text(format_bytes(data, 1));
              return;
            } else {
              $(elem).text("<%= i18n.noValue %>");
              return;
            }
          }
        }
      },

      _setAdvancedInfo: function (info) {
        this.__sortInfo = info;
      },
      _getAdvancedInfo: function(key,rapp,info,asRaw){
        var map = {
          ["peak-size"]: "vm_size",
          ["peak-peak"]: "vm_peak",
          ["current-p"]: "vm_pss",
          ["current-r"]: "vm_rss",
          ["current-vmach"]: "totalbytes",
          ["peak-vmach"]: "totalbytes_max"
        }
        var map_multis = {
          vm_size: 1024,
          vm_peak: 1024,
          vm_pss: 1024,
          vm_rss: 1024,
          totalbytes: 1,
          totalbytes_max: 1
        }
        var text;
        if(info[rapp.id]){
          var rinfo = info[rapp.id];
          var infokey = map[key];
          if(rinfo[infokey]){
            var val = rinfo[infokey] * map_multis[infokey];
            if(asRaw) text = val;
            else text = format_bytes(val);
          }
        }
        return text || "<%= i18n.noValue %>";
      },

      _formatData: function (info) {
        var datasets = [];
        var showCurrents = $(".currentByteShow", this.$.dialog);
        if (info) {
          this._timeCount += 1;
        }
        if(this._selectedPage === "advanced"){
          this._setAdvancedInfo(info);
          return
        }
        for (var i = 0; i < this._selectedRapps.length; i++) {
          var rapp = this._selectedRapps[i];
          if (info && info[rapp.id]) {
            this._addData(rapp, info[rapp.id], i);
          }
          if (this._selectedPage !== "advanced") {
            var sets = this._getSingleData(rapp);
            if (sets) {
              datasets = datasets.concat(sets);
              this._setCurrentShow(rapp, showCurrents, sets);
            }
          }
        }
        if (this._selectedPage === "single") {
          this.__gData = {
            datasets: datasets
          }
          this._update();
        }
      },

      _clipboardFormatGroup: function(header,keyVals){
        var outs = [header + ":"];
        for(var i = 0; i < keyVals.length; i++){
          var v = keyVals[i];
          var key = v.name;
          var val = v.value;
          outs.push(key + ": " + val);
        }
        return outs.join("\n\t");
      },

      _getClipboardText: function(){
        var groups = [];
        if(this.showSystemInfo) groups.push(this._clipboardFormatGroup("System",this.systemInfos));

        if(this.__sortInfo){
          for(var i = 0; i < this.rapps.length; i++){
            var rapp = this.rapps[i];
            var vals = [];

            for(var v = 0; v < this.__columns.length; v++){
              var col = this.__columns[v];
              var val = this._getAdvancedInfo(col.key,rapp,this.__sortInfo,true);
              vals.push({
                name: col.display,
                value: val
              });
            }
            groups.push(this._clipboardFormatGroup(rapp.name,vals));
          }
        }

        return groups.join("\n\n\n");
      },

      _systemTranslationTable: {
        kernel: "<%= i18n.kernel %>",
        kernel_gap: "<%= i18n.kernelGap %>",
        kernel_static: "<%= i18n.kernelStatic %>",
        mem_av: "<%= i18n.memAvailable %>",
        mem_free: "<%= i18n.memFree %>",
        user_space: "<%= i18n.userSpace %>",
      },

      _systemValueFormat: function(val,asRaw){
        if(asRaw) return val;
        return format_bytes(val,10);
      },

      _formatSystem: function(systemMemInfo){
        var newInfos = [];

        var keys = Object.keys(this._systemTranslationTable);
        for(var i = 0; i < keys.length; i++){
          var key = keys[i];
          var name = this._systemTranslationTable[key];
          var val = systemMemInfo[key];
          newInfos.push({
            name: name,
            value: val
          });
        }

        this.systemInfos = newInfos;
      },

      _selectedDataChanged: function () {
        this._formatData();
        if (this._selectedTab === "advanced") {
          this._selectedPage = "advanced";
        } else {
          this._selectedPage = "single";
        }
      },

      _getSelectedIds: function () {
        var ret = [];
        var fromList = this._selectedRapps;
        if(this._selectedPage === "advanced") fromList = this.rapps;
        for (var i = 0; i < fromList.length; i++) {
          ret.push(fromList[i].id);
        }
        return ret;
      },

      _getPromises: function () {
        var ret = [this.$.dialog.opened || this._enableInBackground];
        if(ret[0]){
          var rappList = this._getSelectedIds();
          if (this._enableInBackground || this._selectedPage === "advanced" || this._selectedData === "totalbytes")
            ret.push(long_rpc_promise("com.netdumasoftware.systeminfo", "get_rapp_gstate", rappList))
          if (this._enableInBackground || this._selectedPage === "advanced" || this._selectedData === "memory")
            ret.push(long_rpc_promise("com.netdumasoftware.systeminfo", "get_rapp_meminfo", rappList))

          while (ret.length < 3) ret.push([]);

          if (this.showSystemInfo && (this._enableInBackground || this._selectedPage === "advanced"))
            ret.push(long_rpc_promise("com.netdumasoftware.systeminfo", "get_mem_info", []))
        }
        return ret;
      },

      _mergeData: function (gstates, memInfo) {
        var ret = {};
        for (var i = 0; i < this.rapps.length; i++) {
          var rapp = this.rapps[i];
          var merge = {};
          if (gstates) Object.assign(merge, gstates[rapp.id] || {});
          if (memInfo) Object.assign(merge, memInfo[rapp.id] || {});
          ret[rapp.id] = merge;
        }
        return ret;
      },

      _refreshInterval: 3,
      _refreshLoop: function () {
        if (!this._cycle) {
          this._cycle = start_cycle(this._getPromises.bind(this), function (doStuff, gstates, memInfo, systemMemInfo) {
            if (doStuff) {
              var mergedData = this._mergeData(gstates[0], memInfo[0]);
              this._formatData(mergedData);
              if(systemMemInfo && systemMemInfo[0]) this._formatSystem(systemMemInfo[0]);
            }
          }.bind(this), this._refreshInterval * 1000);
        }
      },

      _enableCurrentPage: function () {
        if (this.__prePage && this._selectedRapps.length === 1) {
          this._removeRappFromSelected(this.__prePage);
        }
        if (this._selectedRapps.length === 0) {
          var rappid = top.location.hash.replace('#', '');
          this._addRappToSelected(rappid);
          this.__prePage = rappid;
        }
      },

      open: function () {
        long_rpc_promise("com.netdumasoftware.procmanager", "installed_rapps", []).done(function (installed) {
          this.rapps = installed[0];
          this._enableCurrentPage();
          this.$.dialog.open();
        }.bind(this));
      },

      close: function () {
        this.$.dialog.close();
      },
    }); </script> </dom-module> 