#!/bin/sh
. $IPKG_INSTROOT/lib/functions.sh
. $IPKG_INSTROOT/lib/functions/network.sh

local wan_intf=$1
local max_mtu=0
local offset=22
local intf_mtu

findmaxmtu() {
	local network_name="$1"
	local intfmtu=0 
	config_get intfmtu "$network_name" mtu 
	config_get intfname "$network_name" ifname
	if [ `echo "$intfname" | grep "veip0_"` ]; then
		if [ $intfmtu -ge $max_mtu ]; then
			max_mtu=$intfmtu
			echo "current max mtu = $max_mtu"
		fi
	fi
}

config_load "network"                     
config_foreach findmaxmtu interface     

wan_ifname=`uci get network.$wan_intf.ifname`
if [ `echo "$wan_ifname" | grep "veip0_"` ] ; then
    intf_mtu=`uci get network.$wan_intf.mtu`
    echo "gpon_mtu:intf:$wan_intf,mtu:$intf_mtu,max_mtu:$max_mtu"
	if [ $intf_mtu ] ; then 
	    echo "config gpon intf mtu"   
	    ifconfig gpondef mtu `expr $max_mtu + $offset`
	    ifconfig gpon0 mtu $max_mtu
	    ifconfig gpon0.0 mtu $max_mtu
	    ifconfig veip0 mtu $max_mtu
	    ifconfig $wan_ifname mtu $intf_mtu
	    echo "config mtu,wan_ifname=$wan_ifname" 
	    wan_proto=`uci get network.$wan_intf.proto`
	    if [ $wan_proto = "pppoe" ] ; then
	        ppp_conn=`ubus call network.interface.$wan_intf status | grep "pppstate" | awk -F: '{print $2}'` echo "ppp_conn:$ppp_conn"
	        if [ `echo "$ppp_conn" | grep -w "connected"` ] ; then
        	    pppoe_if="pppoe-$wan_intf"
        	    pppoe_mtu=`expr $intf_mtu - 8`
        	    ifconfig $pppoe_if mtu $pppoe_mtu
	      	    echo "config pppoe intf,pppif:$pppoe_if,ppp_mtu:$pppoe_mtu"
	        fi
	    else
	        echo "not pppoe intf"
	    fi
	else
	    echo "no mtu found"
	fi
else
    echo "not wan infterace,intf:$wan_intf,ifname:$wan_ifname"
fi


