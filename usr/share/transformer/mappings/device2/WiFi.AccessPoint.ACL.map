-- Manually generated
local Device_WiFi_AccessPoint_i_Multi_ = {
  objectType = {
    name = "Device.WiFi.AccessPoint.{i}.#VENDOR.",
    access = "readOnly", -- currently readWrite not supported
    description = "Configuration of wifi access point",
    minEntries = 1,
    maxEntries = 1,
    parameters = {
      Mode = {
        access = "readWrite",
        type = "string",
        enumeration = {
          "Disabled",
          "WhiteList",
          "BlackList",
	  "Register",
        },
        default = "Disabled",
        description = "Access control list mode used",
      },
    }
    -- MACAddressesNumberOfEntries (Automatically generated by transformer)
  }
}

local mapper, ipairs, register = mapper, ipairs, register
local uciHelper = mapper("ucihelper")
local setOnUci = uciHelper.set_on_uci
local getFromUci = uciHelper.get_from_uci
local generateKey = uciHelper.generate_key
local wirelessBinding = {config = "wireless"}
local isConfigChanged = false
local commitApply = commitapply

local key2Mac = {}
local mac2Key = {}
local key2Data = {}

local modeMap = {
  Disabled = "disabled",
  BlackList = "unlock",
  WhiteList = "lock",
  Register = "register",
  disabled = "Disabled",
  unlock = "BlackList",
  lock = "WhiteList",
  register = "Register",
}

local function getMode(mapping, param, parentKey)
  wirelessBinding.sectionname = parentKey
  wirelessBinding.option = "acl_mode"
  local aclMode = getFromUci(wirelessBinding)
  return modeMap[aclMode] or "Disabled"
end

Device_WiFi_AccessPoint_i_Multi_.get = {
  Mode = getMode,
}

Device_WiFi_AccessPoint_i_Multi_.set = {
  Mode = function(mapping, param, value, parentKey)
    wirelessBinding.sectionname = parentKey
    wirelessBinding.option = "acl_mode"
    if modeMap[value] then
      setOnUci(wirelessBinding,modeMap[value],commitApply)
      isConfigChanged = true
    end
  end
}

Device_WiFi_AccessPoint_i_Multi_.commit = function()
  if isConfigChanged then
    uciHelper.commit(wirelessBinding)
    isConfigChanged = false
  end
end

Device_WiFi_AccessPoint_i_Multi_.revert = function()
  if isConfigChanged then
    uciHelper.revert(wirelessBinding)
    isConfigChanged = false
  end
end

-- Manually generated
local Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_ = {
  objectType = {
    name = "Device.WiFi.AccessPoint.{i}.#VENDOR.MACAddresses.{i}.",
    access = "readWrite",
    description = "Wifi accesspoint mac addresses",
    numEntriesParameter = "MACAddressesNumberOfEntries",
    minEntries = 0,
    maxEntries = math.huge,
    parameters = {
      MACAddress = {
        access = "readWrite",
        type = "string",
        description = "MAC address of wifi device",
      }
    }
  }
}

local nwCommon = mapper("nwcommon")
local splitKey = nwCommon.split_key

local aclModeMap = {
  ['lock'] = "acl_accept_list",
  ['unlock'] = "acl_deny_list",
  ['disabled'] = "",
  ['register'] = "acl_accept_list",
}

local function getBinding(parentKey)
  wirelessBinding.sectionname = parentKey
  wirelessBinding.option = "acl_mode"
  wirelessBinding.default = "disabled"
  local aclMode = getFromUci(wirelessBinding)
  wirelessBinding.option = aclModeMap[aclMode]
  wirelessBinding.default = {}
  return wirelessBinding
end

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.entries = function(mapping, parentKey)
  local entries = {}
  wirelessBinding = getBinding(parentKey)
  local macAddresses = getFromUci(wirelessBinding)
  if type(macAddresses) == "table" then
    local _key
    for index, mac in ipairs(macAddresses) do
      local updatedMAC = mac and parentKey and mac .. parentKey
      if updatedMAC and not mac2Key[updatedMAC] then
        _key = generateKey()
        local baseKey = _key and parentKey and _key .. parentKey
        if baseKey then
          entries[#entries + 1] = _key
          key2Mac[baseKey] = mac
          mac2Key[updatedMAC] = _key
          key2Data[baseKey] = index .. "|" .. parentKey
        end
      elseif updatedMAC then
        entries[#entries + 1] = mac2Key[updatedMAC]
      end
    end
  end
  return entries
end

local function setMacAddress(value, key, parentKey)
  local baseKey = key .. parentKey
  local index, section = splitKey(key2Data[baseKey])
  index = tonumber(index)
  wirelessBinding = getBinding(section)
  local macAddresses = getFromUci(wirelessBinding)
  macAddresses[index] = value
  key2Mac[baseKey] = value
  table.remove(mac2Key, index)
  mac2Key[value .. parentKey] = key
  setOnUci(wirelessBinding, macAddresses, commitApply)
  isConfigChanged = true
end

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.get = {
  MACAddress = function(mapping, param, key, parentKey)
    local macAddress = key2Mac[key .. parentKey]
    return macAddress ~= "00:00:00:00:00:00" and macAddress or ""
  end,
}

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.set = {
  MACAddress = function(mapping, param, value, key, parentKey)
    if nwCommon.isMAC(value) then
      setMacAddress(value, key, parentKey)
    else
      return nil,string.format("%s is not a valid MAC Address",value)
    end
  end,
}

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.add = function(mapping, parentKey)
  wirelessBinding = getBinding(parentKey)
  local macAddresses = getFromUci(wirelessBinding)
  local dummyMac = "00:00:00:00:00:00"
  local index = #macAddresses + 1
  macAddresses[index] = dummyMac
  local newKey = generateKey()
  local updatedNewKey = newKey and parentKey and newKey .. parentKey
  key2Mac[updatedNewKey] = dummyMac
  mac2Key[dummyMac .. parentKey] = newKey
  key2Data[updatedNewKey] = index .. "|" .. parentKey
  setOnUci(wirelessBinding, macAddresses, commitApply)
  isConfigChanged = true
  return newKey
end

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.delete = function(mapping, key, parentKey)
  wirelessBinding = getBinding(parentKey)
  local macAddresses = getFromUci(wirelessBinding)
  local baseKey = key and parentKey and key .. parentKey
  local index = splitKey(key2Data[baseKey])
  table.remove(macAddresses, index)
  mac2Key[key2Mac[baseKey] .. parentKey] = nil
  key2Mac[baseKey] = nil
  setOnUci(wirelessBinding, macAddresses, commitApply)
  isConfigChanged = true
  return true
end

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.commit = function()
  if isConfigChanged then
    uciHelper.commit(wirelessBinding)
    isConfigChanged = false
  end
end

Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_.revert = function()
  if isConfigChanged then
    uciHelper.commit(wirelessBinding)
    isConfigChanged = false
  end
end

local duplicator = mapper("multiroot").duplicate
local duplicates = duplicator(Device_WiFi_AccessPoint_i_Multi_, "#VENDOR", { "X_000E50_ACL", "X_BELGACOM_ACL" })
for _, dupli in ipairs(duplicates) do
  register (dupli)
end

duplicates = duplicator(Device_WiFi_AccessPoint_i_Multi_MACAddresses_i_, "#VENDOR", { "X_000E50_ACL", "X_BELGACOM_ACL" })
for _, dupli in ipairs(duplicates) do
  register (dupli)
end
