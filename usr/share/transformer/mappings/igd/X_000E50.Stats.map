local InternetGatewayDevice_Services_Stats_= {
  objectType = {
    name = "#ROOT.",
    access = "readOnly",
    description = "ONO-Wifi service statistics related parameters",
    minEntries = 0,
    maxEntries = 1,
    parameters = {
      TxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes transmitted from the CPE since last boot(RO)",
      },
      RxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes received by the CPE since last boot (RO)",
      },
      TxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets transmitted from the CPE since last boot(RO)",
      },
      RxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets received by the CPE since last boot (RO)",
      },
      TxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets sent by the CPE(RO)",
      },
      RxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets received by the CPE(RO)",
      },
      TxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped sent by the CPE (RO)",
      },
      RxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped received by the CPE (RO)",
      },
      ClientsCounter = {
        access = "readOnly",
        type = "int",
        description = "Counter for all connected clients. (RO)",
      }
    }
  }
}

local InternetGatewayDevice_Services_Stats_SSID_ = {
  objectType = {
    name = "#ROOT.",
    access = "readOnly",
    description = "ONO-Wifi SSID service statistics related parameters",
    minEntries = 1,
    maxEntries = 1,
    parameters = {
      TxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes transmitted from the CPE since last boot(RO)",
      },
      RxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes received by the CPE since last boot (RO)",
      },
      TxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets transmitted from the CPE since last boot(RO)",
      },
      RxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets received by the CPE since last boot (RO)",
      },
      TxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets sent by the CPE(RO)",
      },
      RxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets received by the CPE(RO)",
      },
      TxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped sent by the CPE(RO)",
      },
      RxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped received by the CPE (RO)",
      },
      ClientsCounter = {
        access = "readOnly",
        type = "int",
        description = "Counter for all connected clients. (RO)",
      }
    }
  }
}

local InternetGatewayDevice_Services_Stats_SSID5_ = {
  objectType = {
    name = "InternetGatewayDevice.Services.X_VFWifi.Stats.SSID5.",
    access = "readOnly",
    description = "ONO-Wifi SSID5 service statistics related parameters",
    minEntries = 1,
    maxEntries = 1,
    parameters = {
      TxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes transmitted from the CPE since last boot(RO)",
      },
      RxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes received by the CPE since last boot (RO)",
      },
      TxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets transmitted from the CPE since last boot(RO)",
      },
      RxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets received by the CPE since last boot (RO)",
      },
      TxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets sent by the CPE(RO)",
      },
      RxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets received by the CPE(RO)",
      },
      TxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped sent by the CPE(RO)",
      },
      RxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped received by the CPE (RO)",
      },
      ClientsCounter = {
        access = "readOnly",
        type = "int",
        description = "Counter for all connected clients. (RO)",
      }
    }
  }
}

local InternetGatewayDevice_Services_Stats_EAPSSID_ = {
  objectType = {
    name = "#ROOT.",
    access = "readOnly",
    description = "ONO-Wifi EAPSSID service statistics related parameters",
    minEntries = 1,
    maxEntries = 1,
    parameters = {
      TxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes transmitted from the CPE since last boot(RO)",
      },
      RxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes received by the CPE since last boot (RO)",
      },
      TxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets transmitted from the CPE since last boot(RO)",
      },
      RxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets received by the CPE since last boot (RO)",
      },
      TxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets sent by the CPE(RO)",
      },
      RxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets received by the CPE(RO)",
      },
      TxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped sent by the CPE(RO)",
      },
      RxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped received by the CPE (RO)",
      },
      ClientsCounter = {
        access = "readOnly",
        type = "int",
        description = "Counter for all connected clients. (RO)",
      }
    }
  }
}

local InternetGatewayDevice_Services_Stats_EAPSSID5_ = {
  objectType = {
    name = "InternetGatewayDevice.Services.X_VFWifi.Stats.EAPSSID5.",
    access = "readOnly",
    description = "ONO-Wifi EAPSSID5 service statistics related parameters",
    minEntries = 1,
    maxEntries = 1,
    parameters = {
      TxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes transmitted from the CPE since last boot(RO)",
      },
      RxBytes = {
        access = "readOnly",
        type = "int",
        description = "Number of bytes received by the CPE since last boot (RO)",
      },
      TxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets transmitted from the CPE since last boot(RO)",
      },
      RxPkts = {
        access = "readOnly",
        type = "int",
        description = "Number of packets received by the CPE since last boot (RO)",
      },
      TxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets sent by the CPE(RO)",
      },
      RxErrors = {
        access = "readOnly",
        type = "int",
        description = "Number of occurred errors in packets received by the CPE(RO)",
      },
      TxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped sent by the CPE(RO)",
      },
      RxDrops = {
        access = "readOnly",
        type = "int",
        description = "Number of packets dropped received by the CPE (RO)",
      },
      ClientsCounter = {
        access = "readOnly",
        type = "int",
        description = "Counter for all connected clients. (RO)",
      }
    }
  }
}

local tostring, tonumber, mapper, register, pairs = tostring, tonumber, mapper, register, pairs
local fon_helper = require('transformer.shared.fon_helper')
local nwCommon = mapper("nwcommon")
local getIntfInfo = nwCommon.getIntfInfo
local conn = mapper("ubus").connect()
local ifnames = {}

-- This is to map corresponding uciOption to each parameters
local statsOptions = {
  TxBytes         = "tx_bytes",
  RxBytes         = "rx_bytes",
  TxPkts          = "tx_packets",
  RxPkts          = "rx_packets",
  TxErrors        = "tx_errors",
  RxErrors        = "rx_errors",
  TxDrops         = "tx_dropped",
  RxDrops         = "rx_dropped"
}

InternetGatewayDevice_Services_Stats_.entries = function(mapping, param, key)
  ifnames = fon_helper.getIfnames()
  return {""}
end

local function get(mapping, param, key)
  if param == "ClientsCounter" then
    local count = 0
    local ap = fon_helper.getAp(ifnames[key])
    local value = conn:call("wireless.accesspoint.station", "get", {name = ap})
    if ap and next(value[ap]) then
      for _, mac in pairs(value[ap]) do
        if mac.assoc_time > 0 and mac.state ~= "Disconnected" then
          count = count + 1
        end
      end
    end
    return tostring(count)
  end
  return ifnames[key] and getIntfInfo(ifnames[key], statsOptions[param], "0") or "0"
end

local function getStats(mapping, param)
  if param ~= "ClientsCounter" then
    local totalClients = tonumber(ifnames.SSID and getIntfInfo(ifnames.SSID, statsOptions[param], "0") or  "0")
                         + tonumber(ifnames.SSID5 and getIntfInfo(ifnames.SSID5, statsOptions[param], "0") or "0")
                         + tonumber(ifnames.EAPSSID and getIntfInfo(ifnames.EAPSSID, statsOptions[param], "0") or "0")
                         + tonumber(ifnames.EAPSSID5 and getIntfInfo(ifnames.EAPSSID5, statsOptions[param], "0") or "0")
    return tostring(totalClients)
  end
  local totalStats = tonumber(get(mapping, param, "SSID")) + tonumber(get(mapping, param, "SSID5")) +
                     tonumber(get(mapping, param, "EAPSSID")) + tonumber(get(mapping, param, "EAPSSID5"))
  return tostring(totalStats)
end

InternetGatewayDevice_Services_Stats_.get = function(mapping, param)
  return getStats(mapping, param)
end
InternetGatewayDevice_Services_Stats_SSID_.get = function(mapping, param)
  return get(mapping, param, "SSID")
end
InternetGatewayDevice_Services_Stats_SSID5_.get = function(mapping, param)
  return get(mapping, param, "SSID5")
end
InternetGatewayDevice_Services_Stats_EAPSSID_.get = function(mapping, param)
  return get(mapping, param, "EAPSSID")
end
InternetGatewayDevice_Services_Stats_EAPSSID5_.get = function(mapping, param)
  return get(mapping, param, "EAPSSID5")
end

register(InternetGatewayDevice_Services_Stats_SSID5_)
register(InternetGatewayDevice_Services_Stats_EAPSSID5_)

local duplicator = mapper("multiroot").duplicate
local duplicates = duplicator(InternetGatewayDevice_Services_Stats_, "#ROOT", {"InternetGatewayDevice.Services.X_VFWifi.Stats", "InternetGatewayDevice.Services.X_000E50_Wifi.Stats"})
for _, dupli in ipairs(duplicates) do
  register(dupli)
end

duplicates = duplicator(InternetGatewayDevice_Services_Stats_SSID_, "#ROOT", {"InternetGatewayDevice.Services.X_VFWifi.Stats.SSID", "InternetGatewayDevice.Services.X_000E50_Wifi.Stats.SSID"})
for _, dupli in ipairs(duplicates) do
  register(dupli)
end

duplicates = duplicator(InternetGatewayDevice_Services_Stats_EAPSSID_, "#ROOT", {"InternetGatewayDevice.Services.X_VFWifi.Stats.EAPSSID", "InternetGatewayDevice.Services.X_000E50_Wifi.Stats.EAPSSID"})
for _, dupli in ipairs(duplicates) do
  register(dupli)
end
