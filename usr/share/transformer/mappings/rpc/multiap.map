-- Manuall generated
local multiap = {
  objectType = {
    name = "rpc.multiap.",
    access = "readOnly",
    minEntries = 1,
    maxEntries = 1,
    parameters = {},
  }
}

register(multiap)

local multiap_device_i_ = {
  objectType = {
    name = "rpc.multiap.device.@.",
    numEntriesParameter = "ExtenderNumberOfEntries",
    access = "readOnly",
    minEntries = 0,
    maxEntries = math.huge,
    parameters = {
      al_mac = {
        access = "readOnly",
        type = "string"
      },
      ip_address = {
        access = "readOnly",
        type = "string"
      },
      state = {
        access = "readOnly",
        type = "unsignedInt"
      },
      backhaul_interface_type = {
        access = "readOnly",
        type = "string"
      },
      parent = {
        access = "readOnly",
        type = "string"
      },
      neighbors = {
        access = "readOnly",
        type = "string"
      },
      manufacturer_name = {
        access = "readOnly",
        type = "string"
      },
      serial_number = {
        access = "readOnly",
        type = "string"
      },
      rssi = {
        access = "readOnly",
        type = "unsignedInt"
      },
      phyrate = {
        access = "readOnly",
        type = "unsignedInt"
      },
      radio_count = {
        access = "readOnly",
        type = "unsignedInt"
      },
      device_name = {
        access = "readOnly",
        type = "string"
      },
    },
  }
}

local conn = mapper("ubus").connect()
local uciHelper = mapper("ucihelper")
local get_from_uci = uciHelper.get_from_uci
local lower = string.lower
local multiapBinding = { config = "multiap" }
local concat = table.concat
local data

local paramMap = {
  state = "status",
  backhaul_interface_type = "backhaul_info",
  parent = "parent",
  neighbors = "neighbors",
  manufacturer_name = "manufacturer_name",
  serial_number = "serial_number",
  rssi = "rssi",
  phyrate = "phyrate",
  radio_count = "radio_count",
}

local function getUciParam(sectionName)
  multiapBinding.sectionname = sectionName
  multiapBinding.option = "macaddress"
  return uciHelper.get_from_uci(multiapBinding)
end

multiap_device_i_.entries = function()
  local entries = {}
  data = conn:call("multiap.controller.agent_info", "get", {}) or {}
  local agentMac = lower(getUciParam("agent"))
  local controllerMac = lower(getUciParam("controller"))
  for mac in pairs(data) do
    if mac ~= agentMac and mac ~= controllerMac then
      entries[#entries + 1] = mac
    end
  end
  return entries
end

multiap_device_i_.get = function(mapping, param, key)
  if param == "al_mac" then
    return key
  elseif param == "device_name" then
    local agentMac = key:match("([^%:]+)$") or ""
    return "agent_" .. agentMac
  elseif param == "ip_address" then
    local interfaces = data[key]["local_interfaces"] or {}
    local ipaddr = {}
    if next(interfaces) then
      for _, mac in ipairs(interfaces) do
        local host_data = conn:call("hostmanager.device", "get", { ["mac-address"] = mac }) or {}
        if next(host_data) then
          for ip,_ in pairs(host_data) do
            for _, idx in pairs(host_data[ip]["ipv4"]) do
              ipaddr[#ipaddr+1] = idx["address"] or ""
            end
          end
        end
      end
    end
    return concat(ipaddr,",")
  elseif paramMap[param] then
    local result = data[key] and data[key][paramMap[param]] or ""
    if param == "state" then
      return result == "ONBOARDED" and "1" or "0"
    elseif param == "backhaul_interface_type" and result then
      return result["interface_type"] or ""
    end
    return type(result) == "table" and table.concat(result, ",") or tostring(result)
  end
end

register(multiap_device_i_)
