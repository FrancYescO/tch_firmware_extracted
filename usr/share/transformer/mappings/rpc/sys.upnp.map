
local sys_upnp_ = {
  objectType = {
    name = "sys.upnp.",
    access = "readOnly",
    minEntries = 1,
    maxEntries = 1,
    parameters = {},
  }
}

register(sys_upnp_)

local sys_upnp_redirect_i_ = {
  objectType = {
    name = "sys.upnp.redirect.{i}.",
    access = "readOnly",
    numEntriesParameter = "RedirectNumberOfEntries",
    minEntries = 0,
    maxEntries = math.huge,
    parameters = {
      proto = {
        access = "readOnly",
        type = "string",
      },
      interface = {
        access = "readOnly",
        type = "string",
      },
      dest_port = {
        access = "readOnly",
        type = "int",
      },
      dest_ip = {
        access = "readOnly",
        type = "string",
      },
      src_dport = {
        access = "readOnly",
        type = "int",
      },
      stop_time = {
        access = "readOnly",
        type = "int",
      },
      description = {
        access = "readOnly",
        type = "string",
      },
    }
  }
}

local leasePath="/var/upnp.leases"
local lease_cache = {}

sys_upnp_redirect_i_.entries = function(mapping)
  local fd = io.open(leasePath)
  if not fd then
    return {}
  end
  lease_cache = {}
  local upnpkeys = {}
  for line in fd:lines() do
    local proto, interface, dest_port, dest_ip, src_dport, stop_time, descr = string.match(line, '([UDTCP]+):(%S+):(%d+):([%d%s%.]+):(%d+):(%d+):([^\r^\n]*)')
    local key = proto .. interface .. dest_port
    upnpkeys[#upnpkeys+1] = key
    lease_cache[key] = {
      proto = proto,
      interface = interface,
      dest_port = dest_port,
      dest_ip = dest_ip,
      src_dport = src_dport,
      stop_time = stop_time,
      description = descr
    }
  end
  fd:close()
  return upnpkeys
end

sys_upnp_redirect_i_.get = function(mapping, param, key)
  return lease_cache[key][param]
end

sys_upnp_redirect_i_.getall = function(mapping, key)
  return lease_cache[key]
end

register(sys_upnp_redirect_i_)

